<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal do Gestor - Sistema Corporativo Avançado</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            /* Light Mode Colors */
            --primary-color: #0056b3;
            --secondary-color: #004085;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --gray-color: #6c757d;
            --border-radius: 8px;
            --box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            --routine-color: #9c27b0;
            --overdue-color: #ff5252;
            --gold: #ffd700;
            --silver: #c0c0c0;
            --bronze: #cd7f32;
            
            /* Dark Mode Colors */
            --bg-primary-dark: #0a0a0a;
            --bg-secondary-dark: #1a1a1a;
            --bg-tertiary-dark: #2a2a2a;
            --text-primary-dark: #ffffff;
            --text-secondary-dark: #b0b0b0;
            --text-muted-dark: #808080;
            --border-dark: #333333;
            --card-dark: #1e1e1e;
            --hover-dark: #2a2a2a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background: var(--bg-primary-dark);
            color: var(--text-primary-dark);
        }

        body.dark-mode .login-card,
        body.dark-mode .card,
        body.dark-mode .stat-card,
        body.dark-mode .chart-container,
        body.dark-mode .ranking-container,
        body.dark-mode .modal-content,
        body.dark-mode .filter-container,
        body.dark-mode .password-modal-content {
            background-color: var(--card-dark);
            color: var(--text-primary-dark);
            border: 1px solid var(--border-dark);
        }

        body.dark-mode .demanda-item {
            background-color: var(--bg-secondary-dark);
            color: var(--text-primary-dark);
            border: 1px solid var(--border-dark);
        }

        body.dark-mode .tab-content {
            background-color: var(--bg-primary-dark);
        }

        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea {
            background-color: var(--bg-secondary-dark);
            color: var(--text-primary-dark);
            border: 1px solid var(--border-dark);
        }

        body.dark-mode .multi-select-dropdown {
            background-color: var(--bg-secondary-dark);
            border: 1px solid var(--border-dark);
        }

        body.dark-mode .multi-select-option {
            color: var(--text-primary-dark);
        }

        body.dark-mode .multi-select-option:hover {
            background-color: var(--hover-dark);
        }

        body.dark-mode .email-template {
            background-color: var(--card-dark);
            border: 1px solid var(--border-dark);
        }

        body.dark-mode .file-list {
            background-color: var(--bg-secondary-dark);
            border: 1px solid var(--border-dark);
        }

        body.dark-mode .file-item {
            border-bottom: 1px solid var(--border-dark);
        }

        body.dark-mode .dias-semana-group {
            background-color: var(--bg-secondary-dark);
        }

        body.dark-mode header {
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
        }

        body.dark-mode .tabs {
            border-bottom: 1px solid var(--border-dark);
        }

        body.dark-mode .tab:hover {
            background-color: var(--hover-dark);
        }

        body.dark-mode .search-bar input {
            background-color: var(--bg-secondary-dark);
            color: var(--text-primary-dark);
            border: 2px solid var(--border-dark);
        }

        body.dark-mode .notification {
            background-color: var(--card-dark);
            color: var(--text-primary-dark);
            border: 1px solid var(--border-dark);
        }

        /* Enhanced Dark Mode Header */
        body.dark-mode .header-controls button {
            background: var(--bg-secondary-dark);
            color: var(--text-primary-dark);
        }

        body.dark-mode .header-controls button:hover {
            background: var(--hover-dark);
        }

        /* Tela de Login */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-card h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .login-card p {
            color: var(--gray-color);
            margin-bottom: 30px;
        }

        .login-form .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-color);
        }

        body.dark-mode .login-form label {
            color: var(--text-primary-dark);
        }

        .login-form input, .login-form select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .login-form input:focus, .login-form select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 86, 179, 0.3);
        }

        .user-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        /* Sistema Principal */
        .main-container {
            display: none;
            background-color: #f5f7fa;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            position: relative;
        }

        header h1 {
            margin: 0;
            font-size: 2.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        header p {
            margin-top: 10px;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .header-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-badge.gestor {
            background: rgba(255, 193, 7, 0.3);
            border: 1px solid rgba(255, 193, 7, 0.5);
        }

        .header-controls button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .header-controls button:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Enhanced Search Bar with Filters */
        .search-container {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        body.dark-mode .search-container {
            background-color: var(--card-dark);
        }

        .search-bar {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-bar input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.1);
        }

        .search-bar i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }

        .advanced-filters {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-tag {
            background: var(--info-color);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-tag i {
            cursor: pointer;
        }

        /* Dashboard com estatísticas */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-color);
        }

        .stat-card.success::before { background: var(--success-color); }
        .stat-card.warning::before { background: var(--warning-color); }
        .stat-card.danger::before { background: var(--danger-color); }
        .stat-card.info::before { background: var(--info-color); }

        .stat-icon {
            font-size: 2rem;
            margin-right: 15px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            position: relative;
        }

        .stat-icon::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: inherit;
            opacity: 0.1;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.1; }
            50% { transform: scale(1.1); opacity: 0.05; }
            100% { transform: scale(1); opacity: 0.1; }
        }

        .stat-icon.primary {
            background-color: rgba(0, 86, 179, 0.1);
            color: var(--primary-color);
        }

        .stat-icon.success {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
        }

        .stat-icon.warning {
            background-color: rgba(255, 193, 7, 0.1);
            color: var(--warning-color);
        }

        .stat-icon.danger {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
        }

        .stat-icon.info {
            background-color: rgba(23, 162, 184, 0.1);
            color: var(--info-color);
        }

        .stat-info h3 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .trend-indicator {
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 12px;
            font-weight: normal;
        }

        .trend-up {
            background: rgba(40, 167, 69, 0.2);
            color: var(--success-color);
        }

        .trend-down {
            background: rgba(220, 53, 69, 0.2);
            color: var(--danger-color);
        }

        .stat-info p {
            color: var(--gray-color);
            font-size: 0.9rem;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            border-left: 5px solid var(--primary-color);
            position: relative;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card h2 {
            margin: 0;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-actions {
            display: flex;
            gap: 10px;
        }

        .card-actions button {
            padding: 5px 10px;
            font-size: 12px;
            background: var(--light-color);
            color: var(--dark-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .card-actions button:hover {
            background: var(--primary-color);
            color: white;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--dark-color);
        }

        body.dark-mode label {
            color: var(--text-primary-dark);
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 86, 179, 0.2);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        .dias-semana-group {
            display: none;
            margin-top: 10px;
            padding: 15px;
            background: var(--light-color);
            border-radius: var(--border-radius);
        }

        .dias-semana-group label {
            display: inline-block;
            margin-right: 10px;
            font-weight: normal;
        }

        .dias-semana-group input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:active::before {
            width: 300px;
            height: 300px;
        }

        button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button.danger {
            background-color: var(--danger-color);
        }

        button.danger:hover {
            background-color: #c82333;
        }

        button.success {
            background-color: var(--success-color);
        }

        button.success:hover {
            background-color: #218838;
        }

        button.secondary {
            background-color: var(--gray-color);
        }

        button.secondary:hover {
            background-color: #5a6268;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .demanda-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            background-color: var(--light-color);
            transition: all 0.3s ease;
            position: relative;
        }

        .demanda-item:hover {
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transform: translateX(5px);
        }

        .demanda-item.pendente { border-left: 5px solid var(--warning-color); }
        .demanda-item.aprovada { border-left: 5px solid var(--success-color); }
        .demanda-item.reprovada { border-left: 5px solid var(--danger-color); }
        .demanda-item.finalizado_pendente_aprovacao { border-left: 5px solid var(--primary-color); }
        .demanda-item.atribuida_pendente_aceitacao { 
            border-left: 5px solid var(--info-color); 
            background-color: rgba(23, 162, 184, 0.1);
        }
        .demanda-item.reprovada_pelo_atribuido { 
            border-left: 5px solid var(--warning-color); 
            background-color: rgba(255, 193, 7, 0.1);
        }
        .demanda-item.atrasado { 
            border-left: 5px solid var(--overdue-color); 
            background-color: rgba(255, 82, 82, 0.1);
        }
        .demanda-item.rotina { 
            border-left: 5px solid var(--routine-color); 
            background-color: rgba(156, 39, 176, 0.1);
        }
        .demanda-item.rotina .demanda-info strong {
            color: var(--routine-color);
        }
        .demanda-item.atrasado .demanda-info .time-remaining {
            color: var(--overdue-color);
            font-weight: bold;
        }

        .demanda-priority {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .priority-high {
            background: var(--danger-color);
            color: white;
        }

        .priority-medium {
            background: var(--warning-color);
            color: var(--dark-color);
        }

        .priority-low {
            background: var(--success-color);
            color: white;
        }

        .demanda-info {
            flex-grow: 1;
        }

        .demanda-info strong {
            display: block;
            font-size: 1.1em;
        }

        .demanda-info small {
            color: var(--gray-color);
            display: block;
            margin-top: 5px;
        }

        .time-remaining {
            font-weight: bold;
            margin-top: 5px;
            padding: 5px 10px;
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
            display: inline-block;
        }

        .time-completed {
            font-weight: bold;
            margin-top: 5px;
            padding: 5px 10px;
            background: rgba(40, 167, 69, 0.1);
            border-radius: 4px;
            display: inline-block;
            color: var(--success-color);
        }
        
        .time-performance {
            font-weight: bold;
            margin-top: 5px;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
        }

        .time-performance.early {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
        }

        .time-performance.late {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
        }

        .acoes-demandas {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .acoes-demandas button {
            margin-right: 5px;
            padding: 5px 10px;
            font-size: 14px;
        }

        .import-area {
            border: 2px dashed #ccc;
            padding: 40px;
            text-align: center;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .import-area.highlight {
            border-color: var(--primary-color);
            background-color: #e9f5ff;
        }

        .import-area i {
            font-size: 3em;
            color: var(--gray-color);
            margin-bottom: 15px;
        }

        .import-area p {
            margin: 0;
            color: var(--gray-color);
        }

        .import-area #importStatus {
            margin-top: 15px;
            font-weight: bold;
        }

        .ranking-container {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }

        .ranking-container h2 {
            margin-top: 0;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ranking-list {
            list-style: none;
            padding: 0;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: all 0.3s ease;
        }

        .ranking-item:hover {
            background: var(--light-color);
            transform: translateX(5px);
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .ranking-position {
            width: 40px;
            height: 40px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            font-size: 1.1rem;
        }

        .ranking-info {
            flex-grow: 1;
        }

        .ranking-info strong {
            display: block;
            font-size: 1.1rem;
        }

        .ranking-info small {
            color: var(--gray-color);
        }

        .ranking-stats {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }

        .ranking-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .stat-badge.concluidas {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--success-color);
        }

        .stat-badge.andamento {
            background-color: rgba(255, 193, 7, 0.2);
            color: var(--warning-color);
        }

        .stat-badge.atrasadas {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--danger-color);
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            overflow-x: auto;
            position: relative;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
            position: relative;
            font-weight: 500;
        }

        .tab:hover {
            background-color: rgba(0, 86, 179, 0.05);
        }

        .tab.active {
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: bold;
        }

        .tab .badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--danger-color);
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.6rem;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            position: relative;
        }

        .chart-container h3 {
            margin-top: 0;
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-actions {
            display: flex;
            gap: 5px;
        }

        .chart-actions button {
            padding: 5px 10px;
            font-size: 12px;
            background: var(--light-color);
            color: var(--dark-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .chart-actions button:hover {
            background: var(--primary-color);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 800px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: var(--danger-color);
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1001;
            max-width: 350px;
            display: none;
            border-left: 5px solid var(--primary-color);
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .notification.show {
            display: block;
        }

        .notification.success {
            border-left-color: var(--success-color);
        }

        .notification.error {
            border-left-color: var(--danger-color);
        }

        .notification.warning {
            border-left-color: var(--warning-color);
        }

        .notification h4 {
            margin: 0 0 10px 0;
            color: var(--dark-color);
        }

        .notification p {
            margin: 0;
            color: var(--gray-color);
        }

        .floating-action-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            font-size: 1.5rem;
            transition: all 0.3s ease;
            z-index: 999;
        }

        .floating-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-container select {
                max-width: 100%;
            }
            
            .header-controls {
                position: static;
                margin-top: 15px;
                justify-content: center;
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
            }

            .search-container {
                flex-direction: column;
            }

            .search-bar {
                min-width: 100%;
            }

            .advanced-filters {
                width: 100%;
                justify-content: flex-start;
            }
        }

        .loading-spinner {
            border: 4px solid rgba(0,0,0,0.1);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--gray-color);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .password-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .password-modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .password-input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .password-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .server-status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 10000;
        }

        .server-status.connected {
            background: rgba(40, 167, 69, 0.8);
        }

        .server-status.disconnected {
            background: rgba(220, 53, 69, 0.8);
        }

        .email-template {
            background: white;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
        }

        .email-template h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .email-template .email-subject {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--dark-color);
        }

        .email-template .email-body {
            white-space: pre-line;
            line-height: 1.5;
            color: var(--dark-color);
        }

        .email-template .email-footer {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            font-size: 0.9rem;
            color: var(--gray-color);
        }

        .file-list {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item button {
            padding: 2px 6px;
            font-size: 12px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        /* Multi-select styles */
        .multi-select-container {
            position: relative;
        }

        .multi-select-display {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            min-height: 42px;
            align-items: center;
        }

        .multi-select-display:hover {
            border-color: var(--primary-color);
        }

        .selected-item {
            background-color: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .selected-item i {
            cursor: pointer;
            font-size: 10px;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .multi-select-option {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .multi-select-option:hover {
            background-color: #f0f0f0;
        }

        .multi-select-option.selected {
            background-color: rgba(0, 86, 179, 0.1);
        }

        .multi-select-option input {
            width: auto;
            margin: 0;
        }

        /* New Features Styles */

        /* Real-time Comments */
        .comments-section {
            margin-top: 20px;
            padding: 15px;
            background: var(--light-color);
            border-radius: var(--border-radius);
        }

        body.dark-mode .comments-section {
            background: var(--bg-secondary-dark);
        }

        .comment-item {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        body.dark-mode .comment-item {
            background: var(--card-dark);
        }

        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .comment-content {
            flex: 1;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .comment-author {
            font-weight: bold;
            color: var(--primary-color);
        }

        .comment-time {
            font-size: 0.8rem;
            color: var(--gray-color);
        }

        .comment-text {
            color: var(--dark-color);
        }

        body.dark-mode .comment-text {
            color: var(--text-primary-dark);
        }

        .comment-input {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .comment-input input {
            flex: 1;
        }

        /* Knowledge Base */
        .knowledge-base {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        body.dark-mode .knowledge-base {
            background: var(--card-dark);
        }

        .kb-search {
            position: relative;
            margin-bottom: 20px;
        }

        .kb-search input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
        }

        .kb-search i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }

        .kb-categories {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .kb-category {
            background: var(--info-color);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .kb-category:hover {
            transform: scale(1.05);
        }

        .kb-articles {
            display: grid;
            gap: 15px;
        }

        .kb-article {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .kb-article:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .kb-article h4 {
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .kb-article p {
            color: var(--gray-color);
            font-size: 0.9rem;
        }

        /* Virtual Assistant */
        .assistant-chat {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 350px;
            height: 450px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            z-index: 998;
        }

        body.dark-mode .assistant-chat {
            background: var(--card-dark);
        }

        .assistant-chat.show {
            display: flex;
        }

        .assistant-header {
            background: var(--primary-color);
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .assistant-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .assistant-message {
            max-width: 80%;
            padding: 10px;
            border-radius: 10px;
        }

        .assistant-message.user {
            align-self: flex-end;
            background: var(--primary-color);
            color: white;
        }

        .assistant-message.bot {
            align-self: flex-start;
            background: var(--light-color);
            color: var(--dark-color);
        }

        body.dark-mode .assistant-message.bot {
            background: var(--bg-secondary-dark);
            color: var(--text-primary-dark);
        }

        .assistant-input {
            padding: 15px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }

        body.dark-mode .assistant-input {
            border-top: 1px solid var(--border-dark);
        }

        .assistant-input input {
            flex: 1;
        }

        .assistant-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--info-color);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            font-size: 1.5rem;
            transition: all 0.3s ease;
            z-index: 997;
        }

        .assistant-toggle:hover {
            transform: scale(1.1);
        }

        /* Custom Tags */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .tag {
            background: var(--info-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tag i {
            cursor: pointer;
            font-size: 10px;
        }

        .tag-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .tag-input {
            flex: 1;
            min-width: 150px;
        }

        /* Activity History */
        .activity-history {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
        }

        body.dark-mode .activity-history {
            background: var(--card-dark);
        }

        .activity-item {
            display: flex;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        body.dark-mode .activity-item {
            border-bottom: 1px solid var(--border-dark);
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .activity-icon.create { background: var(--success-color); }
        .activity-icon.update { background: var(--info-color); }
        .activity-icon.delete { background: var(--danger-color); }
        .activity-icon.approve { background: var(--success-color); }
        .activity-icon.reject { background: var(--warning-color); }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .activity-description {
            color: var(--gray-color);
            font-size: 0.9rem;
        }

        .activity-time {
            font-size: 0.8rem;
            color: var(--gray-color);
        }

        /* Calendar Integration */
        .calendar-view {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        body.dark-mode .calendar-view {
            background: var(--card-dark);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #ddd;
        }

        body.dark-mode .calendar-grid {
            background: var(--border-dark);
        }

        .calendar-day {
            background: white;
            padding: 10px;
            min-height: 80px;
            position: relative;
        }

        body.dark-mode .calendar-day {
            background: var(--card-dark);
        }

        .calendar-day-header {
            font-weight: bold;
            text-align: center;
            padding: 10px;
            background: var(--light-color);
        }

        body.dark-mode .calendar-day-header {
            background: var(--bg-secondary-dark);
        }

        .calendar-event {
            background: var(--primary-color);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.8rem;
            margin-bottom: 2px;
            cursor: pointer;
        }

        /* Report Generator */
        .report-generator {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }

        body.dark-mode .report-generator {
            background: var(--card-dark);
        }

        .report-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .report-preview {
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 20px;
            min-height: 200px;
        }

        body.dark-mode .report-preview {
            border: 1px solid var(--border-dark);
        }

        /* Integration Badges */
        .integration-badges {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .integration-badge {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .integration-badge.slack {
            background: #4A154B;
            color: white;
        }

        .integration-badge.teams {
            background: #2B2C30;
            color: white;
        }

        .integration-badge.calendar {
            background: var(--info-color);
            color: white;
        }

        .integration-badge:hover {
            transform: scale(1.05);
        }

        /* Notification Bell Animation */
        .notification-bell {
            position: relative;
            cursor: pointer;
        }

        .notification-bell.ringing i {
            animation: bellRing 1s ease-in-out infinite;
        }

        @keyframes bellRing {
            0%, 100% { transform: rotate(0deg); }
            10%, 30%, 50%, 70%, 90% { transform: rotate(-10deg); }
            20%, 40%, 60%, 80% { transform: rotate(10deg); }
        }

        /* Progress Indicators */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        body.dark-mode .progress-bar {
            background: var(--bg-secondary-dark);
        }

        .progress-fill {
            height: 100%;
            background: var(--success-color);
            transition: width 0.3s ease;
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .tooltip:hover::after {
            opacity: 1;
        }

        /* Enhanced Filter Container */
        .filter-container {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.9rem;
            font-weight: normal;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }
    </style>
</head>
<body>

<!-- Indicador de Status do Servidor -->
<div class="server-status" id="serverStatus">
    <i class="fas fa-circle"></i> <span id="serverStatusText">Verificando servidor...</span>
</div>

<!-- Tela de Login -->
<div class="login-container" id="loginContainer">
    <div class="login-card">
        <h1><i class="fas fa-chart-line"></i> Portal do Gestor</h1>
        <p>Sistema Corporativo Avançado de Gestão de Demandas</p>
        
        <form class="login-form" id="loginForm">
            <div class="form-group">
                <label for="userSelect">Selecione seu nome:</label>
                <select id="userSelect" required>
                    <option value="">Clique para selecionar...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="passwordInput">Senha:</label>
                <input type="password" id="passwordInput" placeholder="Digite sua senha" required>
            </div>
            
            <div class="user-info">
                <small><i class="fas fa-info-circle"></i> Funcionários: use sua senha padrão</small><br>
                <small><i class="fas fa-shield-alt"></i> Gestor: senha de administrador</small>
            </div>
            
            <button type="submit" class="login-btn">
                <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
            </button>
        </form>
    </div>
</div>

<!-- Sistema Principal -->
<div class="main-container" id="mainContainer">
    <div class="container">
        <header>
            <h1><i class="fas fa-chart-line"></i> Portal do Gestor Corporativo</h1>
            <p>Sistema Avançado de Gestão de Demandas</p>
            <div class="header-controls">
                <div class="user-badge" id="userBadge">
                    <i class="fas fa-user"></i>
                    <span id="userName">Carregando...</span>
                </div>
                <button onclick="toggleDarkMode()" title="Modo Escuro">
                    <i class="fas fa-moon"></i>
                </button>
                <div class="notification-bell" onclick="showNotifications()" title="Notificações">
                    <i class="fas fa-bell"></i>
                    <span class="badge">3</span>
                </div>
                <button onclick="logout()" title="Sair">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <!-- Enhanced Search Bar with Filters -->
        <div class="search-container">
            <div class="search-bar">
                <input type="text" placeholder="Pesquisar demandas, funcionários, categorias..." id="globalSearch">
                <i class="fas fa-search"></i>
            </div>
            <div class="advanced-filters" id="activeFilters">
                <!-- Filtros ativos serão exibidos aqui -->
            </div>
        </div>

        <main>
            <!-- Dashboard com estatísticas -->
            <div class="dashboard">
                <div class="stat-card" onclick="drillDown('total')">
                    <div class="stat-icon primary">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalDemandas">0</h3>
                        <span class="trend-indicator trend-up">+12%</span>
                        <p>Total de Demandas</p>
                    </div>
                </div>
                <div class="stat-card warning" onclick="drillDown('pending')">
                    <div class="stat-icon warning">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="pendentesCount">0</h3>
                        <span class="trend-indicator trend-down">-5%</span>
                        <p>Em Andamento</p>
                    </div>
                </div>
                <div class="stat-card danger" onclick="drillDown('overdue')">
                    <div class="stat-icon danger">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="atrasadasCount">0</h3>
                        <span class="trend-indicator trend-up">+2</span>
                        <p>Atrasadas</p>
                    </div>
                </div>
                <div class="stat-card success" onclick="drillDown('completed')">
                    <div class="stat-icon success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="aprovadasCount">0</h3>
                        <span class="trend-indicator trend-up">+18%</span>
                        <p>Concluídas</p>
                    </div>
                </div>
                <div class="stat-card info" onclick="drillDown('routine')">
                    <div class="stat-icon info">
                        <i class="fas fa-redo"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="rotinaCount">0</h3>
                        <span class="trend-indicator trend-up">+8%</span>
                        <p>Tarefas de Rotina</p>
                    </div>
                </div>
            </div>

            <!-- Enhanced Filter Container -->
            <div class="filter-container">
                <div class="filter-group">
                    <label for="filtroFuncionario">Funcionário:</label>
                    <select id="filtroFuncionario" onchange="applyAdvancedFilters()">
                        <option value="">Todos</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filtroStatus">Status:</label>
                    <select id="filtroStatus" onchange="applyAdvancedFilters()">
                        <option value="">Todos</option>
                        <option value="pendente">Pendente</option>
                        <option value="aprovada">Aprovada</option>
                        <option value="reprovada">Reprovada</option>
                        <option value="atrasada">Atrasada</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filtroPrioridade">Prioridade:</label>
                    <select id="filtroPrioridade" onchange="applyAdvancedFilters()">
                        <option value="">Todas</option>
                        <option value="Importante">Importante</option>
                        <option value="Média">Média</option>
                        <option value="Relevante">Relevante</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filtroCategoria">Categoria:</label>
                    <select id="filtroCategoria" onchange="applyAdvancedFilters()">
                        <option value="">Todas</option>
                        <option value="Prospecção">Prospecção</option>
                        <option value="Reunião">Reunião</option>
                        <option value="Relatório">Relatório</option>
                        <option value="Suporte">Suporte</option>
                        <option value="Desenvolvimento">Desenvolvimento</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filtroPeriodo">Período:</label>
                    <select id="filtroPeriodo" onchange="applyAdvancedFilters()">
                        <option value="7">Últimos 7 dias</option>
                        <option value="30">Últimos 30 dias</option>
                        <option value="90">Últimos 90 dias</option>
                        <option value="365">Último ano</option>
                    </select>
                </div>
                
                <div class="filter-actions">
                    <button onclick="clearAllFilters()" class="secondary">
                        <i class="fas fa-times"></i> Limpar
                    </button>
                    <button onclick="saveFilterPreset()">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                </div>
            </div>

            <!-- Abas para diferentes funcionalidades -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('dashboard')">
                    <i class="fas fa-chart-pie"></i> Dashboard
                    <span class="badge" id="dashboardBadge" style="display: none;">0</span>
                </div>
                <div class="tab" onclick="switchTab('nova')">
                    <i class="fas fa-plus-circle"></i> Nova Demanda
                </div>
                <div class="tab" onclick="switchTab('pendentes')">
                    <i class="fas fa-clock"></i> Pendentes
                    <span class="badge" id="pendingBadge" style="display: none;">0</span>
                </div>
                <div class="tab" onclick="switchTab('atrasadas')">
                    <i class="fas fa-exclamation-triangle"></i> Atrasadas
                    <span class="badge" id="overdueBadge" style="display: none;">0</span>
                </div>
                <div class="tab" onclick="switchTab('aprovadas')">
                    <i class="fas fa-check-circle"></i> Concluídas
                </div>
                <div class="tab" onclick="switchTab('ranking')">
                    <i class="fas fa-chart-bar"></i> Ranking
                </div>
                <div class="tab" onclick="switchTab('relatorios')">
                    <i class="fas fa-file-pdf"></i> Relatórios
                </div>
                <div class="tab" onclick="switchTab('calendario')">
                    <i class="fas fa-calendar"></i> Calendário
                </div>
                <div class="tab" onclick="switchTab('conhecimento')">
                    <i class="fas fa-book"></i> Base de Conhecimento
                </div>
                <div class="tab" id="gestorTab" style="display: none;" onclick="switchTab('cobranca')">
                    <i class="fas fa-envelope"></i> Cobrança
                </div>
                <div class="tab" id="gestorTab2" style="display: none;" onclick="switchTab('exportar')">
                    <i class="fas fa-download"></i> Exportar
                </div>
            </div>

            <!-- Conteúdo das abas -->
            <div id="dashboard" class="tab-content active">
                <!-- Gráficos Interativos -->
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3>
                            <span><i class="fas fa-chart-pie"></i> Distribuição de Status</span>
                            <div class="chart-actions">
                                <button onclick="refreshChart('status')">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button onclick="downloadChart('status')">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </h3>
                        <canvas id="statusChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>
                            <span><i class="fas fa-chart-bar"></i> Demandas por Categoria</span>
                            <div class="chart-actions">
                                <button onclick="refreshChart('categoria')">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button onclick="downloadChart('categoria')">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </h3>
                        <canvas id="categoriaChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>
                            <span><i class="fas fa-chart-bar"></i> Produtividade por Funcionário</span>
                            <div class="chart-actions">
                                <button onclick="refreshChart('productivity')">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button onclick="downloadChart('productivity')">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </h3>
                        <canvas id="productivityChart"></canvas>
                    </div>
                </div>

                <!-- Activity History -->
                <div class="activity-history">
                    <h3><i class="fas fa-history"></i> Histórico de Atividades Recentes</h3>
                    <div id="activityList">
                        <!-- Atividades serão exibidas aqui -->
                    </div>
                </div>
            </div>

            <!-- Aba Nova Demanda -->
            <div id="nova" class="tab-content">
                <div class="card">
                    <h2><i class="fas fa-plus-circle"></i> Registrar Nova Demanda</h2>
                    <form id="demandaForm">
                        <div class="form-group">
                            <label for="nomeDemandaInput">Nome da Demanda:</label>
                            <input type="text" id="nomeDemandaInput" required placeholder="Dê um nome claro para a demanda">
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="categoriaSelect">Categoria:</label>
                                <select id="categoriaSelect" required>
                                    <option value="">Selecione...</option>
                                    <option value="Prospecção">Prospecção</option>
                                    <option value="Reunião">Reunião</option>
                                    <option value="Relatório">Relatório</option>
                                    <option value="Suporte">Suporte</option>
                                    <option value="Desenvolvimento">Desenvolvimento</option>
                                    <option value="Outros">Outros</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="prioridadeSelect">Prioridade:</label>
                                <select id="prioridadeSelect" required>
                                    <option value="">Selecione...</option>
                                    <option value="Importante">Importante</option>
                                    <option value="Média">Média</option>
                                    <option value="Relevante">Relevante</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="complexidadeSelect">Complexidade:</label>
                                <select id="complexidadeSelect" required>
                                    <option value="">Selecione...</option>
                                    <option value="Baixa">Baixa (1-2 dias)</option>
                                    <option value="Média">Média (3-5 dias)</option>
                                    <option value="Alta">Alta (6-10 dias)</option>
                                    <option value="Crítica">Crítica (10+ dias)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="localSelect">Local:</label>
                                <select id="localSelect" required>
                                    <option value="">Selecione...</option>
                                    <option value="Lundin">Lundin</option>
                                    <option value="R&D">R&D</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Custom Tags -->
                        <div class="form-group">
                            <label>Tags Personalizadas:</label>
                            <div class="tag-input-container">
                                <input type="text" id="tagInput" class="tag-input" placeholder="Adicionar tag...">
                                <button type="button" onclick="addTag()">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div class="tags-container" id="tagsContainer">
                                <!-- Tags serão exibidas aqui -->
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="atribuidoASelect">Atribuir a:</label>
                            <div class="multi-select-container" id="atribuidoAContainer">
                                <div class="multi-select-display" id="atribuidoADisplay" onclick="toggleMultiSelect('atribuidoA')">
                                    <span style="color: #999;">Clique para selecionar funcionários...</span>
                                </div>
                                <div class="multi-select-dropdown" id="atribuidoADropdown">
                                    <!-- Opções serão preenchidas dinamicamente -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="demandaInput">Descrição da Demanda:</label>
                            <textarea id="demandaInput" rows="3" required placeholder="Descreva detalhadamente a demanda..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="dataLimiteInput">Data Limite:</label>
                            <input type="date" id="dataLimiteInput" required onchange="validateDeadline()">
                        </div>
                        
                        <!-- Anexos na Criação -->
                        <div class="form-group">
                            <label for="anexosCriacaoInput">Anexar Documentos/Imagens (Opcional):</label>
                            <input type="file" id="anexosCriacaoInput" multiple>
                            <div id="anexosCriacaoList" class="file-list"></div>
                        </div>
                        
                        <!-- Tarefa de Rotina -->
                        <div class="checkbox-group">
                            <input type="checkbox" id="rotinaCheckbox" onchange="toggleRoutineFields()">
                            <label for="rotinaCheckbox">Esta é uma tarefa de rotina</label>
                        </div>
                        
                        <div class="dias-semana-group" id="diasSemanaGroup">
                            <label>Selecione os dias da semana:</label>
                            <div>
                                <label><input type="checkbox" name="diaSemana" value="0"> Domingo</label>
                                <label><input type="checkbox" name="diaSemana" value="1"> Segunda-feira</label>
                                <label><input type="checkbox" name="diaSemana" value="2"> Terça-feira</label>
                                <label><input type="checkbox" name="diaSemana" value="3"> Quarta-feira</label>
                                <label><input type="checkbox" name="diaSemana" value="4"> Quinta-feira</label>
                                <label><input type="checkbox" name="diaSemana" value="5"> Sexta-feira</label>
                                <label><input type="checkbox" name="diaSemana" value="6"> Sábado</label>
                            </div>
                        </div>
                        
                        <!-- Integration Options -->
                        <div class="form-group">
                            <label>Integrações:</label>
                            <div class="integration-badges">
                                <div class="integration-badge slack" onclick="toggleIntegration('slack')">
                                    <i class="fab fa-slack"></i> Slack
                                </div>
                                <div class="integration-badge teams" onclick="toggleIntegration('teams')">
                                    <i class="fab fa-microsoft"></i> Teams
                                </div>
                                <div class="integration-badge calendar" onclick="toggleIntegration('calendar')">
                                    <i class="fas fa-calendar"></i> Calendário
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit">
                            <i class="fas fa-save"></i> Registrar Demanda
                        </button>
                    </form>
                </div>
            </div>

            <!-- Aba Pendentes -->
            <div id="pendentes" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-clock"></i> Demandas Pendentes</h2>
                    </div>
                    <div id="pendentesContainer"></div>
                </div>
            </div>

            <!-- Aba Atrasadas -->
            <div id="atrasadas" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-exclamation-triangle"></i> Demandas Atrasadas</h2>
                        <div class="card-actions" id="gestorActions2" style="display: none;">
                            <button onclick="reassignOverdue()">
                                <i class="fas fa-user-plus"></i> Reatribuir
                            </button>
                            <button onclick="extendDeadlines()">
                                <i class="fas fa-calendar-plus"></i> Estender Prazos
                            </button>
                        </div>
                    </div>
                    <div id="atrasadasContainer"></div>
                </div>
            </div>

            <!-- Aba Concluídas -->
            <div id="aprovadas" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-check-circle"></i> Demandas Concluídas</h2>
                        <div class="card-actions" id="gestorActions3" style="display: none;">
                            <button onclick="exportCompleted()">
                                <i class="fas fa-download"></i> Exportar Concluídas
                            </button>
                            <button onclick="archiveCompleted()">
                                <i class="fas fa-archive"></i> Arquivar
                            </button>
                        </div>
                    </div>
                    <div id="aprovadasContainer"></div>
                </div>
            </div>

            <!-- Aba Ranking -->
            <div id="ranking" class="tab-content">
                <div class="ranking-container">
                    <div class="card-header">
                        <h2><i class="fas fa-chart-bar"></i> Estatísticas por Funcionário</h2>
                        <div class="card-actions">
                            <button onclick="changeRankingPeriod()">
                                <i class="fas fa-calendar"></i> Período
                            </button>
                            <button onclick="exportRanking()" id="exportRankingBtn" style="display: none;">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>
                    </div>
                    <ul class="ranking-list" id="rankingList"></ul>
                </div>
            </div>

            <!-- Aba Relatórios -->
            <div id="relatorios" class="tab-content">
                <div class="report-generator">
                    <h2><i class="fas fa-file-pdf"></i> Gerador de Relatórios Dinâmicos</h2>
                    
                    <div class="report-options">
                        <div class="form-group">
                            <label for="reportType">Tipo de Relatório:</label>
                            <select id="reportType">
                                <option value="productivity">Produtividade</option>
                                <option value="performance">Desempenho</option>
                                <option value="timeline">Linha do Tempo</option>
                                <option value="summary">Resumo Geral</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="reportFormat">Formato:</label>
                            <select id="reportFormat">
                                <option value="pdf">PDF</option>
                                <option value="excel">Excel</option>
                                <option value="csv">CSV</option>
                                <option value="json">JSON</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="reportPeriod">Período:</label>
                            <select id="reportPeriod">
                                <option value="7">Últimos 7 dias</option>
                                <option value="30">Últimos 30 dias</option>
                                <option value="90">Últimos 90 dias</option>
                                <option value="365">Último ano</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="reportFilters">Filtros Adicionais:</label>
                            <textarea id="reportFilters" placeholder="Filtros personalizados (JSON)"></textarea>
                        </div>
                    </div>
                    
                    <div class="report-preview" id="reportPreview">
                        <p><i class="fas fa-info-circle"></i> Configure as opções acima para gerar um relatório</p>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button onclick="generateReport()" class="success">
                            <i class="fas fa-file-pdf"></i> Gerar Relatório
                        </button>
                        <button onclick="scheduleReport()">
                            <i class="fas fa-clock"></i> Agendar
                        </button>
                        <button onclick="saveReportTemplate()">
                            <i class="fas fa-save"></i> Salvar Modelo
                        </button>
                    </div>
                </div>
            </div>

            <!-- Aba Calendário -->
            <div id="calendario" class="tab-content">
                <div class="calendar-view">
                    <div class="calendar-header">
                        <button onclick="previousMonth()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <h3 id="calendarMonth">Mês Atual</h3>
                        <button onclick="nextMonth()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <button onclick="syncCalendar()" class="secondary">
                            <i class="fas fa-sync"></i> Sincronizar
                        </button>
                    </div>
                    
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Calendário será gerado dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- Aba Base de Conhecimento -->
            <div id="conhecimento" class="tab-content">
                <div class="knowledge-base">
                    <h2><i class="fas fa-book"></i> Base de Conhecimento</h2>
                    
                    <div class="kb-search">
                        <input type="text" placeholder="Buscar artigos, soluções, tutoriais..." id="kbSearch">
                        <i class="fas fa-search"></i>
                    </div>
                    
                    <div class="kb-categories">
                        <div class="kb-category" onclick="filterKbCategory('all')">Todos</div>
                        <div class="kb-category" onclick="filterKbCategory('tutorial')">Tutoriais</div>
                        <div class="kb-category" onclick="filterKbCategory('solution')">Soluções</div>
                        <div class="kb-category" onclick="filterKbCategory('faq')">FAQ</div>
                        <div class="kb-category" onclick="filterKbCategory('best-practices')">Boas Práticas</div>
                    </div>
                    
                    <div class="kb-articles" id="kbArticles">
                        <!-- Artigos serão carregados dinamicamente -->
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button onclick="createKbArticle()">
                            <i class="fas fa-plus"></i> Novo Artigo
                        </button>
                    </div>
                </div>
            </div>

            <!-- Aba Cobrança -->
            <div id="cobranca" class="tab-content">
                <div class="card">
                    <h2><i class="fas fa-envelope"></i> Sistema de Cobrança</h2>
                    <p>Envie emails de cobrança para as demandas que estão em atraso.</p>
                    
                    <div class="filter-container">
                        <label for="cobrancaFuncionario">Filtrar por Funcionário:</label>
                        <select id="cobrancaFuncionario">
                            <option value="todos">Todos os Funcionários com Demandas Atrasadas</option>
                        </select>
                        
                        <label for="cobrancaPrioridade">Filtrar por Prioridade:</label>
                        <select id="cobrancaPrioridade">
                            <option value="todas">Todas as Prioridades</option>
                            <option value="Importante">Importante</option>
                            <option value="Média">Média</option>
                            <option value="Relevante">Relevante</option>
                        </select>
                        
                        <button onclick="filtrarCobranca()">
                            <i class="fas fa-filter"></i> Filtrar
                        </button>
                        <button onclick="resetFiltrosCobranca()">
                            <i class="fas fa-undo"></i> Resetar
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-list"></i> Demandas em Atraso</h3>
                            <div class="card-actions">
                                <button onclick="selectAllOverdue()">
                                    <i class="fas fa-check-square"></i> Selecionar Todas
                                </button>
                                <button onclick="deselectAllOverdue()">
                                    <i class="fas fa-square"></i> Desmarcar Todas
                                </button>
                                <button onclick="sendBulkEmail()" class="success">
                                    <i class="fas fa-paper-plane"></i> Enviar Emails em Lote
                                </button>
                            </div>
                        </div>
                        <div id="cobrancaContainer"></div>
                    </div>
                    
                    <div class="email-template">
                        <h3>Modelo de Email de Cobrança</h3>
                        <div class="email-subject">Assunto: [ASSUNTO]</div>
                        <div class="email-body" id="emailPreview">
[CORPO DO EMAIL]
                        </div>
                        <div class="email-footer">
                            Este email será enviado automaticamente pelo sistema de gestão de demandas.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba Exportar (apenas gestor) -->
            <div id="exportar" class="tab-content">
                <div class="card">
                    <h2><i class="fas fa-download"></i> Exportar Dados</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="exportFormat">Formato:</label>
                            <select id="exportFormat">
                                <option value="csv">CSV</option>
                                <option value="excel">Excel</option>
                                <option value="pdf">PDF</option>
                                <option value="json">JSON</option>
                                <option value="xml">XML</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="exportPeriod">Período:</label>
                            <select id="exportPeriod">
                                <option value="7">Últimos 7 dias</option>
                                <option value="30">Últimos 30 dias</option>
                                <option value="90">Últimos 90 dias</option>
                                <option value="365">Último ano</option>
                                <option value="all">Todo o período</option>
                            </select>
                        </div>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="includeCharts" checked>
                        <label for="includeCharts">Incluir gráficos</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="includeComments" checked>
                        <label for="includeComments">Incluir comentários</label>
                    </div>
                    <button onclick="exportData()">
                        <i class="fas fa-download"></i> Exportar Dados
                    </button>
                    <button onclick="scheduleExport()">
                        <i class="fas fa-clock"></i> Agendar Exportação
                    </button>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Virtual Assistant -->
<button class="assistant-toggle" onclick="toggleAssistant()">
    <i class="fas fa-robot"></i>
</button>

<div class="assistant-chat" id="assistantChat">
    <div class="assistant-header">
        <span><i class="fas fa-robot"></i> Assistente Virtual</span>
        <button onclick="toggleAssistant()" style="background: none; border: none; color: white;">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="assistant-messages" id="assistantMessages">
        <div class="assistant-message bot">
            Olá! Sou o assistente virtual do sistema. Como posso ajudar você hoje?
        </div>
    </div>
    <div class="assistant-input">
        <input type="text" id="assistantInput" placeholder="Digite sua pergunta..." onkeypress="handleAssistantInput(event)">
        <button onclick="sendAssistantMessage()">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>

<!-- Modal de Senha para Aprovação -->
<div id="passwordModal" class="password-modal">
    <div class="password-modal-content">
        <h3><i class="fas fa-lock"></i> Autenticação Requerida</h3>
        <p>Apenas o gestor pode aprovar ou reprovar demandas.</p>
        <input type="password" id="passwordConfirm" class="password-input" placeholder="Digite a senha do gestor">
        <div class="password-buttons">
            <button onclick="confirmPassword()" class="success">
                <i class="fas fa-check"></i> Confirmar
            </button>
            <button onclick="closePasswordModal()" class="danger">
                <i class="fas fa-times"></i> Cancelar
            </button>
        </div>
    </div>
</div>

<!-- Modal de Resolução de Demanda -->
<div id="resolucaoModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('resolucaoModal')">&times;</span>
        <h2 id="resolucaoModalTitle">Resolver Demanda</h2>
        
        <!-- Real-time Comments Section -->
        <div class="comments-section">
            <h4><i class="fas fa-comments"></i> Comentários em Tempo Real</h4>
            <div id="commentsContainer">
                <!-- Comentários serão exibidos aqui -->
            </div>
            <div class="comment-input">
                <input type="text" id="commentInput" placeholder="Adicionar comentário..." onkeypress="handleCommentInput(event)">
                <button onclick="addComment()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
        
        <form id="resolucaoForm">
            <div class="form-group">
                <label for="resolucaoComentarios">Comentários sobre a resolução:</label>
                <textarea id="resolucaoComentarios" rows="4" required placeholder="Descreva como a demanda foi resolvida, quais foram os desafios, etc."></textarea>
            </div>
            <div class="form-group">
                <label for="resolucaoAnexos">Anexar Documentos/Imagens:</label>
                <input type="file" id="resolucaoAnexos" multiple>
                <div id="anexosList" class="file-list"></div>
            </div>
            <div class="form-group">
                <button type="submit" class="success">
                    <i class="fas fa-save"></i> Salvar Resolução e Baixar Anexos
                </button>
                <button type="button" class="secondary" onclick="closeModal('resolucaoModal')">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Reprovação por Atribuição -->
<div id="atribuicaoReprovacaoModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('atribuicaoReprovacaoModal')">&times;</span>
        <h2><i class="fas fa-times-circle"></i> Reprovar Demanda Atribuída</h2>
        <form id="atribuicaoReprovacaoForm">
            <div class="form-group">
                <label for="motivoReprovacaoAtribuicao">Motivo da Reprovação:</label>
                <textarea id="motivoReprovacaoAtribuicao" rows="4" required placeholder="Por favor, justifique o motivo da reprovação desta demanda para que o solicitante possa entender e ajustar."></textarea>
            </div>
            <div class="form-group">
                <button type="submit" class="danger">
                    <i class="fas fa-times"></i> Reprovar Demanda
                </button>
                <button type="button" class="secondary" onclick="closeModal('atribuicaoReprovacaoModal')">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Sistema de Notificações -->
<div id="notification" class="notification">
    <h4><i class="fas fa-bell"></i> <span id="notificationTitle">Notificação</span></h4>
    <p id="notificationMessage">Mensagem da notificação</p>
</div>

<!-- Modal para Detalhes -->
<div id="detailModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('detailModal')">&times;</span>
        <h2 id="modalTitle">Detalhes da Demanda</h2>
        <div id="modalBody">
            <!-- Conteúdo dinâmico -->
        </div>
    </div>
</div>

<script>
    // Sistema de Usuários
    const usuarios = [
        { 
            id: 1, 
            nome: 'Ranielly Miranda De Souza', 
            email: 'ranielly-s@zaminebrasil.com', 
            nivel: 'Senior', 
            pontos: 450, 
            conquistas: ['star', 'fire', 'gold'],
            senha: '123456',
            role: 'funcionario'
        },
        { 
            id: 2, 
            nome: 'Girlene da Silva Nogueira', 
            email: 'girlene-n@zaminebrasil.com', 
            nivel: 'Pleno', 
            pontos: 380, 
            conquistas: ['star', 'silver'],
            senha: '123456',
            role: 'funcionario'
        },
        { 
            id: 3, 
            nome: 'Rafaela Cristine da Silva Martins', 
            email: 'rafaela-m@zaminebrasil.com', 
            nivel: 'Senior', 
            pontos: 520, 
            conquistas: ['star', 'fire', 'gold'],
            senha: '123456',
            role: 'funcionario'
        },
        { 
            id: 4, 
            nome: 'Alvino Alberto Junior', 
            email: 'alvino-j@zaminebrasil.com', 
            nivel: 'Pleno', 
            pontos: 320, 
            conquistas: ['star'],
            senha: '123456',
            role: 'funcionario'
        },
        { 
            id: 5, 
            nome: 'Marcos Antônio Lino Rosa', 
            email: 'marcos-a@zaminebrasil.com', 
            nivel: 'Junior', 
            pontos: 280, 
            conquistas: ['star'],
            senha: '123456',
            role: 'funcionario'
        },
        { 
            id: 6, 
            nome: 'Marcos Paulo Moraes Borges', 
            email: 'marcos-b@zaminebrasil.com', 
            nivel: 'Pleno', 
            pontos: 410, 
            conquistas: ['star', 'silver'],
            senha: '123456',
            role: 'funcionario'
        },
        { 
            id: 7, 
            nome: 'Marcelo Goncalves de Paula', 
            email: 'marcelo-p@zaminebrasil.com', 
            nivel: 'Senior', 
            pontos: 480, 
            conquistas: ['star', 'fire', 'gold'],
            senha: '123456',
            role: 'funcionario'
        },
        { 
            id: 8, 
            nome: 'Higor Ataides Macedo', 
            email: 'higor-a@zaminebrasil.com', 
            nivel: 'Junior', 
            pontos: 250, 
            conquistas: ['star'],
            senha: '123456',
            role: 'funcionario'
        },
        { 
            id: 9, 
            nome: 'Weslley Ferreira de Siqueira', 
            email: 'weslley-f@zaminebrasil.com', 
            nivel: 'Pleno', 
            pontos: 360, 
            conquistas: ['star', 'silver'],
            senha: '123456',
            role: 'funcionario'
        },
        { 
            id: 10, 
            nome: 'Jadson Joao Romano', 
            email: 'jadson-r@zaminebrasil.com', 
            nivel: 'Senior', 
            pontos: 440, 
            conquistas: ['star', 'fire', 'gold'],
            senha: '123456',
            role: 'funcionario'
        },
        { 
            id: 11, 
            nome: 'Charles de Andrade', 
            email: 'charles-a@zaminebrasil.com', 
            nivel: 'Pleno', 
            pontos: 390, 
            conquistas: ['star', 'silver'],
            senha: '123456',
            role: 'funcionario'
        },
        { 
            id: 12, 
            nome: 'Jose Carlos Rodrigues de Santana', 
            email: 'jose-s@zaminebrasil.com', 
            nivel: 'Junior', 
            pontos: 220, 
            conquistas: ['star'],
            senha: '123456',
            role: 'funcionario'
        },
        { 
            id: 13, 
            nome: 'Max Henrique Araujo', 
            email: 'max-r@zaminebrasil.com', 
            nivel: 'Pleno', 
            pontos: 340, 
            conquistas: ['star', 'silver'],
            senha: '123456',
            role: 'funcionario'
        },
        { 
            id: 14, 
            nome: 'Demetrius Rufino', 
            email: 'demetrius-r@zaminebrasil.com', 
            nivel: 'Senior', 
            pontos: 460, 
            conquistas: ['star', 'fire', 'gold'],
            senha: '123456',
            role: 'funcionario'
        },
        { 
            id: 99, 
            nome: 'Gestor do Sistema', 
            email: 'gestor@zaminebrasil.com', 
            nivel: 'Administrador', 
            pontos: 999, 
            conquistas: ['star', 'fire', 'gold', 'crown'],
            senha: 'admin123',
            role: 'gestor'
        }
    ];

    // Variáveis globais
    let usuarioLogado = null;
    let todasDemandas = [];
    let timerInterval;
    let charts = {};
    let filtroFuncionarioAtual = 'todos';
    let darkMode = false;
    let notifications = [];
    let pendingAction = null;
    let selectedOverdueItems = [];
    let demandaResolucaoAtual = null;
    let demandaAtribuicaoAtual = null;
    let selectedUsers = [];
    let customTags = [];
    let activeFilters = {};
    let activityHistory = [];
    let currentMonth = new Date();
    let integrations = {
        slack: false,
        teams: false,
        calendar: false
    };

    // Base de Conhecimento
    const knowledgeBase = [
        {
            id: 1,
            title: "Como criar uma nova demanda",
            category: "tutorial",
            content: "Para criar uma nova demanda, clique na aba 'Nova Demanda' e preencha todos os campos obrigatórios...",
            author: "Sistema",
            date: new Date()
        },
        {
            id: 2,
            title: "Solução para problemas de sincronização",
            category: "solution",
            content: "Se estiver enfrentando problemas de sincronização, verifique sua conexão com a internet e tente recarregar a página...",
            author: "Suporte",
            date: new Date()
        },
        {
            id: 3,
            title: "FAQ - Perguntas Frequentes",
            category: "faq",
            content: "P: Como redefinir minha senha? R: Entre em contato com o administrador do sistema...",
            author: "FAQ",
            date: new Date()
        },
        {
            id: 4,
            title: "Melhores práticas para gestão de demandas",
            category: "best-practices",
            content: "1. Sempre defina prazos realistas. 2. Use tags para organizar melhor. 3. Mantenha os comentários atualizados...",
            author: "Gestão",
            date: new Date()
        }
    ];

    // URL do servidor
    const SERVER_URL = window.location.origin;

    // Status do servidor
    let serverConnected = false;

    // Inicialização
    document.addEventListener('DOMContentLoaded', () => {
        console.log('Inicializando sistema...');
        carregarUsuariosNoSelect();
        inicializarEventListeners();
        verificarStatusServidor();
        
        // Verifica se há sessão salva
        const sessao = sessionStorage.getItem('usuarioLogado');
        if (sessao) {
            usuarioLogado = JSON.parse(sessao);
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            configurarInterfaceUsuario();
            inicializarSistemaPrincipal();
        }
        
        console.log('Sistema inicializado com sucesso!');
    });

    // Verificar status do servidor
    async function verificarStatusServidor() {
        const statusElement = document.getElementById('serverStatus');
        const statusText = document.getElementById('serverStatusText');
        
        try {
            const response = await fetch(`${SERVER_URL}/api/demandas`);
            if (response.ok) {
                serverConnected = true;
                statusElement.className = 'server-status connected';
                statusText.textContent = 'Servidor conectado';
            } else {
                throw new Error('Servidor não respondeu');
            }
        } catch (error) {
            serverConnected = false;
            statusElement.className = 'server-status disconnected';
            statusText.textContent = 'Servidor desconectado';
        }
        
        // Tenta reconectar a cada 30 segundos
        setTimeout(verificarStatusServidor, 30000);
    }

    // Carregar usuários no select de login
    function carregarUsuariosNoSelect() {
        console.log('Carregando usuários no select...');
        const userSelect = document.getElementById('userSelect');
        if (userSelect) {
            usuarios.forEach(usuario => {
                const option = new Option(usuario.nome, usuario.id);
                userSelect.add(option);
            });
            console.log('Usuários carregados no select de login');
        }
    }

    // Sistema de Login
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const userId = document.getElementById('userSelect').value;
        const password = document.getElementById('passwordInput').value;
        
        const usuario = usuarios.find(u => u.id == userId);
        
        if (!usuario) {
            showNotification('error', 'Erro de Login', 'Usuário não encontrado');
            return;
        }
        
        if (usuario.senha !== password) {
            showNotification('error', 'Erro de Login', 'Senha incorreta');
            return;
        }
        
        // Login bem sucedido
        usuarioLogado = usuario;
        console.log('Login bem sucedido:', usuarioLogado.nome);
        
        // Salva sessão
        sessionStorage.setItem('usuarioLogado', JSON.stringify(usuario));
        
        // Mostra sistema principal
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
        
        // Configura interface baseado no papel do usuário
        configurarInterfaceUsuario();
        
        // Inicializa sistema
        inicializarSistemaPrincipal();
        
        showNotification('success', 'Bem-vindo!', `Olá, ${usuario.nome}! Você está logado como ${usuario.role === 'gestor' ? 'Gestor' : 'Funcionário'}`);
    });

    // Configurar interface baseado no papel do usuário
    function configurarInterfaceUsuario() {
        const userBadge = document.getElementById('userBadge');
        const userName = document.getElementById('userName');
        
        if (userBadge && userName) {
            userName.textContent = usuarioLogado.nome;
            
            if (usuarioLogado.role === 'gestor') {
                userBadge.classList.add('gestor');
                userBadge.innerHTML = '<i class="fas fa-user-shield"></i> <span>' + usuarioLogado.nome + ' (Gestor)</span>';
                
                // Mostra abas e ações do gestor
                document.getElementById('gestorTab').style.display = 'block';
                document.getElementById('gestorTab2').style.display = 'block';
                document.getElementById('gestorActions2').style.display = 'flex';
                document.getElementById('gestorActions3').style.display = 'flex';
                document.getElementById('exportRankingBtn').style.display = 'inline-block';
            } else {
                userBadge.innerHTML = '<i class="fas fa-user"></i> <span>' + usuarioLogado.nome + '</span>';
            }
        }
    }

    // Inicializar sistema principal após login
    async function inicializarSistemaPrincipal() {
        carregarFuncionariosNosSelect();
        await carregarDadosDoServidor();
        inicializarImportacaoJSON();
        atualizarDashboard();
        atualizarRanking();
        inicializarGraficos();
        inicializarCalendario();
        carregarBaseConhecimento();
        inicializarNotificacoesTempoReal();
        
        // Inicia o contador de tempo
        timerInterval = setInterval(atualizarTemposRestantes, 1000);
    }

    // Logout
    function logout() {
        if (confirm('Tem certeza que deseja sair do sistema?')) {
            sessionStorage.removeItem('usuarioLogado');
            location.reload();
        }
    }

    // Carregar funcionários nos selects (exceto login)
    function carregarFuncionariosNosSelect() {
        console.log('Carregando funcionários nos selects...');
        const selects = ['filtroFuncionario', 'cobrancaFuncionario'];
        
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (select) {
                // Limpa o select antes de adicionar
                select.innerHTML = '';
                
                // Adiciona a opção padrão
                if (selectId === 'filtroFuncionario') {
                    const defaultOption = new Option('Todos', '');
                    select.add(defaultOption);
                } else if (selectId === 'cobrancaFuncionario') {
                    const defaultOption = new Option('Todos os Funcionários com Demandas Atrasadas', 'todos');
                    select.add(defaultOption);
                }

                usuarios.filter(u => u.role === 'funcionario').forEach(func => {
                    // Removendo a nomenclatura de nível (pleno, senior, etc.)
                    const option = new Option(func.nome, func.id);
                    select.add(option);
                });
                console.log(`Funcionários carregados no select: ${selectId}`);
            }
        });
        
        // Inicializa o campo de seleção múltipla
        inicializarCampoMultiSelect();
    }

    // Inicializa o campo de seleção múltipla para atribuição de demandas
    function inicializarCampoMultiSelect() {
        const dropdown = document.getElementById('atribuidoADropdown');
        if (!dropdown) return;
        
        // Limpa o dropdown
        dropdown.innerHTML = '';
        
        // Adiciona as opções de usuários
        usuarios.filter(u => u.role === 'funcionario').forEach(usuario => {
            const option = document.createElement('div');
            option.className = 'multi-select-option';
            option.innerHTML = `
                <input type="checkbox" id="user_${usuario.id}" value="${usuario.id}">
                <label for="user_${usuario.id}">${usuario.nome}</label>
            `;
            
            option.addEventListener('click', function(e) {
                if (e.target.tagName !== 'INPUT') {
                    const checkbox = this.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                }
                updateSelectedUsers();
            });
            
            dropdown.appendChild(option);
        });
    }

    // Alterna a exibição do dropdown de seleção múltipla
    function toggleMultiSelect(id) {
        const dropdown = document.getElementById(id + 'Dropdown');
        if (dropdown.style.display === 'block') {
            dropdown.style.display = 'none';
        } else {
            // Fecha todos os outros dropdowns
            document.querySelectorAll('.multi-select-dropdown').forEach(d => {
                d.style.display = 'none';
            });
            dropdown.style.display = 'block';
        }
    }

    // Atualiza a lista de usuários selecionados
    function updateSelectedUsers() {
        selectedUsers = [];
        const checkboxes = document.querySelectorAll('#atribuidoADropdown input[type="checkbox"]:checked');
        
        checkboxes.forEach(checkbox => {
            const userId = parseInt(checkbox.value);
            const usuario = usuarios.find(u => u.id === userId);
            if (usuario) {
                selectedUsers.push(usuario);
            }
        });
        
        // Atualiza o display
        const display = document.getElementById('atribuidoADisplay');
        if (selectedUsers.length === 0) {
            display.innerHTML = '<span style="color: #999;">Clique para selecionar funcionários...</span>';
        } else {
            display.innerHTML = selectedUsers.map(user => 
                `<span class="selected-item">${user.nome} <i class="fas fa-times" onclick="removeUser(${user.id})"></i></span>`
            ).join('');
        }
    }

    // Remove um usuário da seleção
    function removeUser(userId) {
        const checkbox = document.getElementById(`user_${userId}`);
        if (checkbox) {
            checkbox.checked = false;
            updateSelectedUsers();
        }
    }

    // Carregar dados do servidor
    async function carregarDadosDoServidor() {
        console.log('Carregando dados do servidor...');
        try {
            const response = await fetch(`${SERVER_URL}/api/demandas`);
            if (response.ok) {
                todasDemandas = await response.json();
                console.log(`Carregadas ${todasDemandas.length} demandas do servidor`);
            } else {
                console.error('Erro ao carregar demandas do servidor');
                showNotification('error', 'Erro de Conexão', 'Não foi possível conectar ao servidor. Verifique se o servidor está rodando.');
            }
        } catch (error) {
            console.error('Erro de conexão com o servidor:', error);
            showNotification('error', 'Erro de Conexão', 'Não foi possível conectar ao servidor. Verifique se o servidor está rodando.');
        }
        
        renderizarDemandas();
        renderizarCobranca();
        atualizarBadges();
        atualizarHistoricoAtividades();
    }

    // Salvar dados no servidor
    async function salvarDemandaNoServidor(demanda) {
        console.log('Salvando demanda no servidor...');
        try {
            const response = await fetch(`${SERVER_URL}/api/demandas`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(demanda)
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    console.log('Demanda salva com sucesso no servidor');
                    return true;
                }
            }
        } catch (error) {
            console.error('Erro ao salvar demanda no servidor:', error);
            showNotification('error', 'Erro ao Salvar', 'Não foi possível salvar a demanda no servidor.');
        }
        
        return false;
    }

    // Atualizar demanda no servidor
    async function atualizarDemandaNoServidor(id, dadosAtualizados) {
        console.log('Atualizando demanda no servidor...');
        try {
            // Busca a demanda existente primeiro para não apagar dados
            const demandaExistente = todasDemandas.find(d => d.id === id);
            if (!demandaExistente) {
                showNotification('error', 'Erro ao Atualizar', 'Demanda não encontrada.');
                return false;
            }

            // Mescla os dados existentes com os novos
            const dadosCompletos = { ...demandaExistente, ...dadosAtualizados };

            const response = await fetch(`${SERVER_URL}/api/demandas/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dadosCompletos)
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    console.log('Demanda atualizada com sucesso no servidor');
                    
                    // Adiciona ao histórico de atividades
                    adicionarAtividade({
                        tipo: 'update',
                        usuario: usuarioLogado.nome,
                        demanda: demandaExistente.nomeDemanda,
                        descricao: `Demanda atualizada: ${Object.keys(dadosAtualizados).join(', ')}`,
                        data: new Date()
                    });
                    
                    return true;
                }
            }
        } catch (error) {
            console.error('Erro ao atualizar demanda no servidor:', error);
            showNotification('error', 'Erro ao Atualizar', 'Não foi possível atualizar a demanda no servidor.');
        }
        
        return false;
    }

    // Deletar demanda do servidor
    async function deletarDemandaDoServidor(id) {
        console.log('Deletando demanda do servidor...');
        try {
            const response = await fetch(`${SERVER_URL}/api/demandas/${id}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    console.log('Demanda deletada com sucesso do servidor');
                    
                    // Adiciona ao histórico de atividades
                    const demanda = todasDemandas.find(d => d.id === id);
                    if (demanda) {
                        adicionarAtividade({
                            tipo: 'delete',
                            usuario: usuarioLogado.nome,
                            demanda: demanda.nomeDemanda,
                            descricao: 'Demanda excluída',
                            data: new Date()
                        });
                    }
                    
                    return true;
                }
            }
        } catch (error) {
            console.error('Erro ao deletar demanda no servidor:', error);
            showNotification('error', 'Erro ao Deletar', 'Não foi possível deletar a demanda no servidor.');
        }
        
        return false;
    }

    // Adicionar atividade ao histórico
    function adicionarAtividade(atividade) {
        activityHistory.unshift(atividade);
        if (activityHistory.length > 50) {
            activityHistory = activityHistory.slice(0, 50);
        }
        atualizarHistoricoAtividades();
    }

    // Atualizar exibição do histórico de atividades
    function atualizarHistoricoAtividades() {
        const activityList = document.getElementById('activityList');
        if (!activityList) return;
        
        if (activityHistory.length === 0) {
            activityList.innerHTML = '<p>Nenhuma atividade recente.</p>';
            return;
        }
        
        activityList.innerHTML = activityHistory.slice(0, 10).map(atividade => {
            const iconMap = {
                create: 'fa-plus',
                update: 'fa-edit',
                delete: 'fa-trash',
                approve: 'fa-check',
                reject: 'fa-times'
            };
            
            return `
                <div class="activity-item">
                    <div class="activity-icon ${atividade.tipo}">
                        <i class="fas ${iconMap[atividade.tipo] || 'fa-info'}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${atividade.descricao}</div>
                        <div class="activity-description">por ${atividade.usuario}</div>
                        <div class="activity-time">${formatTime(atividade.data)}</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Atualizar badges nas abas
    function atualizarBadges() {
        const pendentes = todasDemandas.filter(d => d.status === 'pendente' || d.status === 'finalizado_pendente_aprovacao' || d.status === 'atribuida_pendente_aceitacao').length;
        const atrasadas = todasDemandas.filter(d => {
            if (d.status === 'aprovada') return false;
            const dataLimite = new Date(d.dataLimite);
            const hoje = new Date();
            return dataLimite < hoje;
        }).length;
        
        updateBadge('pendingBadge', pendentes);
        updateBadge('overdueBadge', atrasadas);
        updateBadge('dashboardBadge', Math.floor(Math.random() * 10)); // Simulado
    }

    function updateBadge(badgeId, count) {
        const badge = document.getElementById(badgeId);
        if (badge) {
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
    }

    // Modo escuro aprimorado
    function toggleDarkMode() {
        darkMode = !darkMode;
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', darkMode);
        
        // Atualiza ícone
        const icon = document.querySelector('.header-controls button i.fa-moon, .header-controls button i.fa-sun');
        if (icon) {
            icon.className = darkMode ? 'fas fa-sun' : 'fas fa-moon';
        }
        
        showNotification('info', 'Modo Escuro', darkMode ? 'Modo escuro ativado' : 'Modo claro ativado');
    }

    // Mostrar notificações
    function showNotifications() {
        if (notifications.length === 0) {
            showNotification('info', 'Notificações', 'Você não possui notificações no momento.');
            return;
        }
        
        // Exibir últimas 5 notificações
        const recentNotifications = notifications.slice(-5);
        recentNotifications.forEach((notif, index) => {
            setTimeout(() => {
                showNotification(notif.tipo, notif.titulo, notif.mensagem);
            }, index * 200);
        });
    }

    // Filtros Avançados
    function applyAdvancedFilters() {
        activeFilters = {
            funcionario: document.getElementById('filtroFuncionario').value,
            status: document.getElementById('filtroStatus').value,
            prioridade: document.getElementById('filtroPrioridade').value,
            categoria: document.getElementById('filtroCategoria').value,
            periodo: document.getElementById('filtroPeriodo').value
        };
        
        // Exibe filtros ativos
        const activeFiltersContainer = document.getElementById('activeFilters');
        activeFiltersContainer.innerHTML = '';
        
        Object.entries(activeFilters).forEach(([key, value]) => {
            if (value) {
                const filterTag = document.createElement('div');
                filterTag.className = 'filter-tag';
                filterTag.innerHTML = `
                    ${key}: ${value}
                    <i class="fas fa-times" onclick="removeFilter('${key}')"></i>
                `;
                activeFiltersContainer.appendChild(filterTag);
            }
        });
        
        // Aplica filtros na exibição
        renderizarDemandas();
        atualizarGraficos();
        
        showNotification('info', 'Filtros Aplicados', `${Object.values(activeFilters).filter(v => v).length} filtro(s) ativo(s)`);
    }

    function removeFilter(filterKey) {
        document.getElementById(`filtro${filterKey.charAt(0).toUpperCase() + filterKey.slice(1)}`).value = '';
        applyAdvancedFilters();
    }

    function clearAllFilters() {
        document.querySelectorAll('.filter-container select').forEach(select => {
            select.value = '';
        });
        applyAdvancedFilters();
    }

    function saveFilterPreset() {
        const presetName = prompt('Nome para este conjunto de filtros:');
        if (presetName) {
            localStorage.setItem(`filterPreset_${presetName}`, JSON.stringify(activeFilters));
            showNotification('success', 'Filtros Salvos', `Preset "${presetName}" salvo com sucesso`);
        }
    }

    // Sistema de Tags Personalizadas
    function addTag() {
        const tagInput = document.getElementById('tagInput');
        const tagValue = tagInput.value.trim();
        
        if (tagValue && !customTags.includes(tagValue)) {
            customTags.push(tagValue);
            renderTags();
            tagInput.value = '';
        }
    }

    function removeTag(tag) {
        customTags = customTags.filter(t => t !== tag);
        renderTags();
    }

    function renderTags() {
        const container = document.getElementById('tagsContainer');
        container.innerHTML = customTags.map(tag => `
            <span class="tag">
                ${tag}
                <i class="fas fa-times" onclick="removeTag('${tag}')"></i>
            </span>
        `).join('');
    }

    // Integrações
    function toggleIntegration(integration) {
        integrations[integration] = !integrations[integration];
        
        if (integrations[integration]) {
            showNotification('success', 'Integração Ativada', `${integration.charAt(0).toUpperCase() + integration.slice(1)} integrado com sucesso`);
        } else {
            showNotification('info', 'Integração Desativada', `${integration.charAt(0).toUpperCase() + integration.slice(1)} desativado`);
        }
    }

    // Sistema de Comentários em Tempo Real
    function addComment() {
        const commentInput = document.getElementById('commentInput');
        const commentText = commentInput.value.trim();
        
        if (commentText) {
            const comment = {
                id: Date.now(),
                author: usuarioLogado.nome,
                text: commentText,
                time: new Date()
            };
            
            // Adiciona ao container de comentários
            const container = document.getElementById('commentsContainer');
            const commentElement = document.createElement('div');
            commentElement.className = 'comment-item';
            commentElement.innerHTML = `
                <div class="comment-avatar">${usuarioLogado.nome.charAt(0)}</div>
                <div class="comment-content">
                    <div class="comment-header">
                        <span class="comment-author">${usuarioLogado.nome}</span>
                        <span class="comment-time">agora</span>
                    </div>
                    <div class="comment-text">${commentText}</div>
                </div>
            `;
            container.appendChild(commentElement);
            
            commentInput.value = '';
            
            // Simula envio para outros usuários
            if (Math.random() > 0.7) {
                setTimeout(() => {
                    simulateOtherUserComment();
                }, 2000);
            }
        }
    }

    function handleCommentInput(event) {
        if (event.key === 'Enter') {
            addComment();
        }
    }

    function simulateOtherUserComment() {
        const otherUsers = usuarios.filter(u => u.id !== usuarioLogado.id && u.role === 'funcionario');
        const randomUser = otherUsers[Math.floor(Math.random() * otherUsers.length)];
        const comments = [
            'Concordo com essa abordagem',
            'Ótima ideia!',
            'Vamos trabalhar nisso juntos',
            'Posso ajudar com essa parte',
            'Excelente progresso'
        ];
        
        const comment = {
            id: Date.now(),
            author: randomUser.nome,
            text: comments[Math.floor(Math.random() * comments.length)],
            time: new Date()
        };
        
        const container = document.getElementById('commentsContainer');
        const commentElement = document.createElement('div');
        commentElement.className = 'comment-item';
        commentElement.innerHTML = `
            <div class="comment-avatar">${randomUser.nome.charAt(0)}</div>
            <div class="comment-content">
                <div class="comment-header">
                    <span class="comment-author">${randomUser.nome}</span>
                    <span class="comment-time">agora</span>
                </div>
                <div class="comment-text">${comment.text}</div>
            </div>
        `;
        container.appendChild(commentElement);
        
        // Notificação
        showNotification('info', 'Novo Comentário', `${randomUser.nome} comentou na demanda`);
    }

    // Base de Conhecimento
    function carregarBaseConhecimento() {
        renderKnowledgeArticles();
    }

    function renderKnowledgeArticles(category = 'all') {
        const container = document.getElementById('kbArticles');
        const filteredArticles = category === 'all' 
            ? knowledgeBase 
            : knowledgeBase.filter(article => article.category === category);
        
        container.innerHTML = filteredArticles.map(article => `
            <div class="kb-article" onclick="viewKbArticle(${article.id})">
                <h4>${article.title}</h4>
                <p>${article.content.substring(0, 100)}...</p>
                <small>Categoria: ${article.category} | Autor: ${article.author}</small>
            </div>
        `).join('');
    }

    function filterKbCategory(category) {
        renderKnowledgeArticles(category);
    }

    function viewKbArticle(articleId) {
        const article = knowledgeBase.find(a => a.id === articleId);
        if (article) {
            showModal('detailModal', article.title, `
                <div class="kb-article-detail">
                    <p><strong>Categoria:</strong> ${article.category}</p>
                    <p><strong>Autor:</strong> ${article.author}</p>
                    <p><strong>Data:</strong> ${article.date.toLocaleDateString('pt-BR')}</p>
                    <hr>
                    <p>${article.content}</p>
                </div>
            `);
        }
    }

    function createKbArticle() {
        const title = prompt('Título do artigo:');
        const content = prompt('Conteúdo do artigo:');
        
        if (title && content) {
            const newArticle = {
                id: Date.now(),
                title: title,
                category: 'tutorial',
                content: content,
                author: usuarioLogado.nome,
                date: new Date()
            };
            
            knowledgeBase.push(newArticle);
            renderKnowledgeArticles();
            showNotification('success', 'Artigo Criado', 'Artigo adicionado à base de conhecimento');
        }
    }

    // Calendário
    function inicializarCalendario() {
        renderCalendar();
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const monthYear = document.getElementById('calendarMonth');
        
        if (!grid || !monthYear) return;
        
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        
        monthYear.textContent = `${currentMonth.toLocaleDateString('pt-BR', { month: 'long' })} ${year}`;
        
        // Primeiro dia do mês
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        let html = '';
        
        // Cabeçalho dos dias da semana
        const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
        weekDays.forEach(day => {
            html += `<div class="calendar-day-header">${day}</div>`;
        });
        
        // Dias vazios antes do primeiro dia
        for (let i = 0; i < firstDay; i++) {
            html += '<div class="calendar-day"></div>';
        }
        
        // Dias do mês
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const dateStr = date.toISOString().split('T')[0];
            
            // Verifica se há demandas neste dia
            const dayDemandas = todasDemandas.filter(d => {
                const dataLimite = new Date(d.dataLimite).toISOString().split('T')[0];
                return dataLimite === dateStr;
            });
            
            html += `
                <div class="calendar-day">
                    <strong>${day}</strong>
                    ${dayDemandas.map(d => `
                        <div class="calendar-event" title="${d.nomeDemanda}">
                            ${d.nomeDemanda.substring(0, 15)}...
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        grid.innerHTML = html;
    }

    function previousMonth() {
        currentMonth.setMonth(currentMonth.getMonth() - 1);
        renderCalendar();
    }

    function nextMonth() {
        currentMonth.setMonth(currentMonth.getMonth() + 1);
        renderCalendar();
    }

    function syncCalendar() {
        showNotification('info', 'Sincronizando', 'Sincronizando com calendário externo...');
        
        // Simula sincronização
        setTimeout(() => {
            showNotification('success', 'Sincronizado', 'Calendário sincronizado com sucesso');
        }, 2000);
    }

    // Gerador de Relatórios
    function generateReport() {
        const type = document.getElementById('reportType').value;
        const format = document.getElementById('reportFormat').value;
        const period = document.getElementById('reportPeriod').value;
        
        showNotification('info', 'Gerando Relatório', `Gerando relatório ${type} em formato ${format}...`);
        
        // Simula geração do relatório
        setTimeout(() => {
            if (format === 'pdf') {
                generatePDFReport(type, period);
            } else if (format === 'excel') {
                generateExcelReport(type, period);
            } else {
                downloadJSONReport(type, period);
            }
        }, 1500);
    }

    function generatePDFReport(type, period) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(20);
        doc.text('Relatório de ' + type, 20, 20);
        
        doc.setFontSize(12);
        doc.text('Período: ' + period + ' dias', 20, 30);
        doc.text('Data de geração: ' + new Date().toLocaleDateString('pt-BR'), 20, 40);
        
        // Adiciona dados do relatório
        let yPosition = 60;
        const demandasFiltradas = filterDemandasByPeriod(period);
        
        demandasFiltradas.forEach((demanda, index) => {
            if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
            }
            
            doc.text(`${index + 1}. ${demanda.nomeDemanda}`, 20, yPosition);
            doc.text(`   Status: ${demanda.status} | Prioridade: ${demanda.prioridade}`, 20, yPosition + 5);
            yPosition += 15;
        });
        
        doc.save(`relatorio_${type}_${Date.now()}.pdf`);
        showNotification('success', 'Relatório Gerado', 'PDF baixado com sucesso');
    }

    function generateExcelReport(type, period) {
        // Simulação de geração Excel
        const data = filterDemandasByPeriod(period).map(d => ({
            'Nome': d.nomeDemanda,
            'Status': d.status,
            'Prioridade': d.prioridade,
            'Categoria': d.categoria,
            'Data Limite': new Date(d.dataLimite).toLocaleDateString('pt-BR')
        }));
        
        const csvContent = convertToCSV(data);
        downloadFile(csvContent, `relatorio_${type}_${Date.now()}.csv`, 'text/csv');
        showNotification('success', 'Relatório Gerado', 'Arquivo CSV baixado com sucesso');
    }

    function downloadJSONReport(type, period) {
        const data = {
            type: type,
            period: period,
            generatedAt: new Date().toISOString(),
            data: filterDemandasByPeriod(period)
        };
        
        const jsonContent = JSON.stringify(data, null, 2);
        downloadFile(jsonContent, `relatorio_${type}_${Date.now()}.json`, 'application/json');
        showNotification('success', 'Relatório Gerado', 'Arquivo JSON baixado com sucesso');
    }

    function filterDemandasByPeriod(period) {
        const days = parseInt(period);
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - days);
        
        return todasDemandas.filter(d => new Date(d.dataCriacao) >= cutoffDate);
    }

    function convertToCSV(data) {
        if (data.length === 0) return '';
        
        const headers = Object.keys(data[0]);
        const csvHeaders = headers.join(',');
        
        const csvRows = data.map(row => {
            return headers.map(header => {
                const value = row[header];
                return typeof value === 'string' && value.includes(',') 
                    ? `"${value}"` 
                    : value;
            }).join(',');
        });
        
        return csvHeaders + '\n' + csvRows.join('\n');
    }

    function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    function scheduleReport() {
        showNotification('info', 'Agendamento', 'Funcionalidade de agendamento em desenvolvimento');
    }

    function saveReportTemplate() {
        showNotification('info', 'Modelo Salvo', 'Modelo de relatório salvo com sucesso');
    }

    // Assistente Virtual
    function toggleAssistant() {
        const chat = document.getElementById('assistantChat');
        chat.classList.toggle('show');
    }

    function sendAssistantMessage() {
        const input = document.getElementById('assistantInput');
        const message = input.value.trim();
        
        if (message) {
            addAssistantMessage(message, 'user');
            input.value = '';
            
            // Simula resposta do assistente
            setTimeout(() => {
                const response = generateAssistantResponse(message);
                addAssistantMessage(response, 'bot');
            }, 1000);
        }
    }

    function handleAssistantInput(event) {
        if (event.key === 'Enter') {
            sendAssistantMessage();
        }
    }

    function addAssistantMessage(message, sender) {
        const container = document.getElementById('assistantMessages');
        const messageElement = document.createElement('div');
        messageElement.className = `assistant-message ${sender}`;
        messageElement.textContent = message;
        container.appendChild(messageElement);
        container.scrollTop = container.scrollHeight;
    }

    function generateAssistantResponse(message) {
        const responses = {
            'ajuda': 'Posso ajudar com criação de demandas, relatórios, ou responder dúvidas sobre o sistema.',
            'demanda': 'Para criar uma demanda, vá na aba "Nova Demanda" e preencha todos os campos obrigatórios.',
            'relatório': 'Os relatórios podem ser gerados na aba "Relatórios". Escolha o tipo, formato e período desejados.',
            'atraso': 'Demandas atrasadas aparecem na aba "Atrasadas" com destaque em vermelho.',
            'calendário': 'O calendário mostra todas as demandas com suas datas limite. Você pode navegar pelos meses.',
            'default': 'Entendi. Posso ajudar com mais alguma coisa? Tente perguntar sobre "demanda", "relatório", "atraso" ou "calendário".'
        };
        
        const lowerMessage = message.toLowerCase();
        
        for (const [key, response] of Object.entries(responses)) {
            if (lowerMessage.includes(key)) {
                return response;
            }
        }
        
        return responses.default;
    }

    // Sistema de Notificações em Tempo Real
    function inicializarNotificacoesTempoReal() {
        // Simula notificações em tempo real
        setInterval(() => {
            if (Math.random() > 0.85) {
                const tipos = ['success', 'warning', 'info'];
                const mensagens = [
                    { titulo: 'Nova demanda concluída', mensagem: 'Uma demanda foi marcada como concluída' },
                    { titulo: 'Demanda próxima do prazo', mensagem: 'Uma demanda atinge o prazo em 24 horas' },
                    { titulo: 'Funcionário disponível', mensagem: 'Um funcionário ficou disponível para novas tarefas' },
                    { titulo: 'Meta alcançada', mensagem: 'A meta semanal foi alcançada!' },
                    { titulo: 'Novo comentário', mensagem: 'Alguém comentou em uma demanda que você segue' }
                ];
                
                const tipo = tipos[Math.floor(Math.random() * tipos.length)];
                const msg = mensagens[Math.floor(Math.random() * mensagens.length)];
                
                // Adiciona ao array de notificações
                notifications.push({
                    tipo: tipo,
                    titulo: msg.titulo,
                    mensagem: msg.mensagem,
                    data: new Date()
                });
                
                // Anima o sino
                const bell = document.querySelector('.notification-bell');
                if (bell) {
                    bell.classList.add('ringing');
                    setTimeout(() => bell.classList.remove('ringing'), 1000);
                }
                
                showNotification(tipo, msg.titulo, msg.mensagem);
            }
        }, 30000); // A cada 30 segundos
        
        // Atualiza contadores de notificações
        setInterval(() => {
            const badge = document.querySelector('.notification-bell .badge');
            if (badge && notifications.length > 0) {
                badge.textContent = Math.min(notifications.length, 99);
                badge.style.display = 'inline-block';
            }
        }, 5000);
    }

    // Funções utilitárias
    function formatDate(date) {
        return new Date(date).toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function formatTime(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (minutes < 1) return 'agora';
        if (minutes < 60) return `há ${minutes} minuto${minutes > 1 ? 's' : ''}`;
        if (hours < 24) return `há ${hours} hora${hours > 1 ? 's' : ''}`;
        return `há ${days} dia${days > 1 ? 's' : ''}`;
    }

    function switchTab(tabName) {
        console.log(`Mudando para aba: ${tabName}`);
        
        // Remove a classe active de todas as abas e conteúdos
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Encontra a aba correta
        let targetTab = null;
        document.querySelectorAll('.tab').forEach(tab => {
            if (tab.onclick && tab.onclick.toString().includes(tabName)) {
                targetTab = tab;
            }
        });
        
        if (!targetTab) {
            const tabNames = ['dashboard', 'nova', 'pendentes', 'atrasadas', 'aprovadas', 'ranking', 'relatorios', 'calendario', 'conhecimento', 'cobranca', 'exportar'];
            const index = tabNames.indexOf(tabName);
            if (index !== -1) {
                targetTab = document.querySelectorAll('.tab')[index];
            }
        }
        
        if (targetTab) {
            targetTab.classList.add('active');
        }
        
        // Ativa o conteúdo correspondente
        const contentElement = document.getElementById(tabName);
        if (contentElement) {
            contentElement.classList.add('active');
        }

        // Atualiza conteúdo específico da aba
        if (tabName === 'pendentes') {
            setTimeout(() => renderizarDemandas(), 100);
        } else if (tabName === 'cobranca') {
            setTimeout(() => renderizarCobranca(), 100);
        } else if (tabName === 'dashboard') {
            setTimeout(() => atualizarGraficos(), 100);
        } else if (tabName === 'calendario') {
            setTimeout(() => renderCalendar(), 100);
        }
    }

    function showModal(modalId, title, content) {
        const modal = document.getElementById(modalId);
        const modalTitle = document.getElementById('resolucaoModalTitle');
        const modalBody = document.getElementById('modalBody');
        
        if (modalId === 'resolucaoModal') {
            if (modal && modalTitle) {
                modalTitle.textContent = title;
                modal.style.display = 'block';
            }
        } else {
            if (modal && modalTitle && modalBody) {
                modalTitle.textContent = title;
                modalBody.innerHTML = content;
                modal.style.display = 'block';
            }
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
            if (modalId === 'resolucaoModal') {
                document.getElementById('resolucaoForm').reset();
                document.getElementById('anexosList').innerHTML = '';
                demandaResolucaoAtual = null;
            }
            if (modalId === 'atribuicaoReprovacaoModal') {
                document.getElementById('atribuicaoReprovacaoForm').reset();
                demandaAtribuicaoAtual = null;
            }
        }
    }

    // Continuação das funções existentes...
    function renderizarDemandas() {
        console.log('=== RENDERIZANDO DEMANDAS ===');
        
        const pendentesContainer = document.getElementById('pendentesContainer');
        const aprovadasContainer = document.getElementById('aprovadasContainer');
        const atrasadasContainer = document.getElementById('atrasadasContainer');
        
        // Limpa todos os containers
        if (pendentesContainer) pendentesContainer.innerHTML = '';
        if (aprovadasContainer) aprovadasContainer.innerHTML = '';
        if (atrasadasContainer) atrasadasContainer.innerHTML = '';

        // Aplica filtros avançados
        let demandasFiltradas = todasDemandas;
        
        if (activeFilters.funcionario) {
            demandasFiltradas = demandasFiltradas.filter(d => d.funcionarioId == activeFilters.funcionario);
        }
        if (activeFilters.status) {
            demandasFiltradas = demandasFiltradas.filter(d => d.status === activeFilters.status);
        }
        if (activeFilters.prioridade) {
            demandasFiltradas = demandasFiltradas.filter(d => d.prioridade === activeFilters.prioridade);
        }
        if (activeFilters.categoria) {
            demandasFiltradas = demandasFiltradas.filter(d => d.categoria === activeFilters.categoria);
        }
        if (activeFilters.periodo) {
            const days = parseInt(activeFilters.periodo);
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - days);
            demandasFiltradas = demandasFiltradas.filter(d => new Date(d.dataCriacao) >= cutoffDate);
        }

        // Filtra as demandas pendentes
        const pendentes = demandasFiltradas.filter(d => {
            return d.status === 'pendente' || d.status === 'reprovada' || d.status === 'finalizado_pendente_aprovacao' || d.status === 'atribuida_pendente_aceitacao' || d.status === 'reprovada_pelo_atribuido';
        });
        
        // Filtra as demandas concluídas
        const concluidas = demandasFiltradas.filter(d => d.status === 'aprovada');
        
        // Filtra as demandas atrasadas
        const atrasadas = demandasFiltradas.filter(d => {
            if (d.status === 'aprovada') return false;
            const dataLimite = new Date(d.dataLimite);
            const hoje = new Date();
            return dataLimite < hoje;
        });

        // Renderiza as demandas pendentes
        if (pendentesContainer) {
            if (pendentes.length === 0) {
                pendentesContainer.innerHTML = '<p>Nenhuma demanda pendente no momento.</p>';
            } else {
                pendentes.forEach(demanda => {
                    const elemento = criarElementoDemanda(demanda);
                    pendentesContainer.appendChild(elemento);
                });
            }
        }

        // Renderiza as demandas atrasadas
        if (atrasadasContainer) {
            if (atrasadas.length === 0) {
                atrasadasContainer.innerHTML = '<p>Nenhuma demanda atrasada no momento.</p>';
            } else {
                atrasadas.forEach(demanda => {
                    atrasadasContainer.appendChild(criarElementoDemanda(demanda, true));
                });
            }
        }

        // Renderiza as demandas concluídas
        if (aprovadasContainer) {
            if (concluidas.length === 0) {
                aprovadasContainer.innerHTML = '<p>Nenhuma demanda concluída a ser exibida.</p>';
            } else {
                concluidas.forEach(demanda => {
                    aprovadasContainer.appendChild(criarElementoDemanda(demanda));
                });
            }
        }
        
        console.log('=== FIM DA RENDERIZAÇÃO ===');
    }

    function criarElementoDemanda(demanda, isAtrasada = false) {
        const div = document.createElement('div');
        const statusClass = isAtrasada ? 'atrasado' : demanda.status;
        div.className = `demanda-item ${statusClass} ${demanda.isRotina ? 'rotina' : ''}`;
        
        let statusIcon = '⏳';
        if (demanda.status === 'aprovada') statusIcon = '✅';
        if (demanda.status === 'reprovada' || demanda.status === 'reprovada_pelo_atribuido') statusIcon = '❌';
        if (demanda.status === 'finalizado_pendente_aprovacao') statusIcon = '📋';
        if (demanda.status === 'atribuida_pendente_aceitacao') statusIcon = '👤';
        if (isAtrasada) statusIcon = '⚠️';
        
        const dataLimiteFormatada = new Date(demanda.dataLimite).toLocaleDateString('pt-BR');
        const rotinaInfo = demanda.isRotina ? `<small><i class="fas fa-redo"></i> Tarefa de rotina</small>` : '';

        let infoAdicional = '';
        if (demanda.status === 'finalizado_pendente_aprovacao') {
            infoAdicional = `<br><small><strong>Comentários do Funcionário:</strong> ${demanda.comentarios}</small>`;
        }
        if (demanda.status === 'reprovada_pelo_atribuido') {
            infoAdicional = `<br><small><strong>Motivo da Reprovação:</strong> ${demanda.comentarioReprovacaoAtribuicao}</small>`;
        }
        
        let diasFormatados = '';
        if (demanda.isRotina && demanda.diasSemana) {
            diasFormatados = demanda.diasSemana.map(dia => ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'][dia]).join(', ');
        }
        
        // Adiciona o contador de tempo restante ou performance
        let tempoElement = '';
        if (demanda.status === 'aprovada' && demanda.dataConclusao) {
            const performanceText = calcularDesempenhoTempo(demanda.dataCriacao, demanda.dataConclusao, demanda.dataLimite);
            const performanceClass = performanceText.includes('antes') ? 'early' : 'late';
            tempoElement = `<div class="time-performance ${performanceClass}">${performanceText}</div>`;
        } else {
            const tempoRestante = calcularTempoRestante(demanda.dataLimite);
            tempoElement = `<div class="time-remaining">${isAtrasada ? 'ATRASADA HÁ ' : 'TEMPO RESTANTE: '}${tempoRestante}</div>`;
        }
        
        // Badge de prioridade
        const priorityBadge = demanda.prioridade ? 
            `<span class="demanda-priority priority-${demanda.prioridade.toLowerCase()}">${demanda.prioridade}</span>` : '';
        
        // Verifica quem é o usuário logado e qual seu papel em relação a demanda
        const podeAprovar = usuarioLogado && usuarioLogado.role === 'gestor';
        const eDono = usuarioLogado && usuarioLogado.id === demanda.funcionarioId;
        const eAtribuido = usuarioLogado && demanda.atribuidos && demanda.atribuidos.some(a => a.id === usuarioLogado.id);
        
        // Formata a lista de atribuídos
        let atribuidosInfo = '';
        if (demanda.atribuidos && demanda.atribuidos.length > 0) {
            atribuidosInfo = `<small><strong>Atribuída a:</strong> ${demanda.atribuidos.map(a => a.nome).join(', ')}</small>`;
        }
        
        // Formata as tags personalizadas
        let tagsInfo = '';
        if (demanda.customTags && demanda.customTags.length > 0) {
            tagsInfo = `<div class="tags-container">${demanda.customTags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>`;
        }
        
        // Barra de progresso
        let progressBar = '';
        if (demanda.status !== 'aprovada' && demanda.status !== 'reprovada') {
            const progress = calcularProgressoDemanda(demanda);
            progressBar = `
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
                <small>Progresso: ${progress}%</small>
            `;
        }
        
        div.innerHTML = `
            ${priorityBadge}
            <div class="demanda-info">
                <strong>${demanda.nomeFuncionario} - ${demanda.nomeDemanda || demanda.descricao}</strong>
                <small>Categoria: ${demanda.categoria} | ${statusIcon} ${demanda.status.replace(/_/g, ' ')} | Local: ${demanda.local || 'N/A'} | Data Limite: ${dataLimiteFormatada}</small>
                ${atribuidosInfo}
                <small><strong>TAG:</strong> ${demanda.tag}</small>
                ${demanda.comentarioGestor ? `<br><small><strong>Comentário do Gestor:</strong> ${demanda.comentarioGestor}</small>` : ''}
                ${infoAdicional}
                ${rotinaInfo}
                ${diasFormatados ? `<small><strong>Dias da semana:</strong> ${diasFormatados}</small>` : ''}
                ${tagsInfo}
                ${progressBar}
                ${tempoElement}
            </div>
            <div class="acoes-demandas">
                ${eDono && (demanda.status === 'pendente' || demanda.status === 'reprovada') ? `
                    <button class="success" onclick="abrirModalResolucao(${demanda.id})" title="Resolver Demanda">
                        <i class="fas fa-tools"></i>
                    </button>
                ` : ''}
                ${eAtribuido && demanda.status === 'atribuida_pendente_aceitacao' ? `
                    <button class="success" onclick="aceitarDemandaAtribuida(${demanda.id})" title="Aceitar Demanda">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="danger" onclick="abrirModalReprovarAtribuicao(${demanda.id})" title="Reprovar Demanda">
                        <i class="fas fa-times"></i>
                    </button>
                ` : ''}
                ${podeAprovar && (demanda.status === 'finalizado_pendente_aprovacao') ? `
                    <button class="success" onclick="solicitarSenhaParaAprovar(${demanda.id}, '${demanda.nomeFuncionario}')" title="Aprovar">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="danger" onclick="solicitarSenhaParaReprovar(${demanda.id}, '${demanda.nomeFuncionario}')" title="Reprovar">
                        <i class="fas fa-times"></i>
                    </button>
                ` : ''}
                <button class="secondary" onclick="verDetalhes(${demanda.id})" title="Ver Detalhes">
                    <i class="fas fa-eye"></i>
                </button>
                ${podeAprovar ? `
                    <button class="danger" onclick="apagarDemanda(${demanda.id})" title="Apagar">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : ''}
            </div>
        `;
        return div;
    }

    function calcularProgressoDemanda(demanda) {
        const criacao = new Date(demanda.dataCriacao);
        const limite = new Date(demanda.dataLimite);
        const agora = new Date();
        
        const tempoTotal = limite - criacao;
        const tempoDecorrido = agora - criacao;
        
        const progresso = Math.min(100, Math.max(0, (tempoDecorrido / tempoTotal) * 100));
        
        return Math.round(progresso);
    }

    // Inicializar event listeners
    function inicializarEventListeners() {
        console.log('Inicializando event listeners...');
        
        // Formulário de demanda
        const form = document.getElementById('demandaForm');
        if (form) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Coleta os dados do formulário
                const nomeDemanda = document.getElementById('nomeDemandaInput').value;
                const categoria = document.getElementById('categoriaSelect').value;
                const prioridade = document.getElementById('prioridadeSelect').value;
                const complexidade = document.getElementById('complexidadeSelect').value;
                const descricao = document.getElementById('demandaInput').value;
                const local = document.getElementById('localSelect').value;
                const dataLimite = document.getElementById('dataLimiteInput').value;
                const isRotina = document.getElementById('rotinaCheckbox').checked;
                const anexosInput = document.getElementById('anexosCriacaoInput');
                
                // Validação básica
                if (!nomeDemanda || !categoria || !prioridade || !complexidade || !descricao || !local || !dataLimite) {
                    showNotification('error', 'Erro', 'Por favor, preencha todos os campos obrigatórios');
                    return;
                }
                
                // Coleta os anexos
                let anexosCriacao = [];
                if (anexosInput.files.length > 0) {
                    for (const file of anexosInput.files) {
                        anexosCriacao.push({
                            nome: file.name,
                            tamanho: file.size,
                            tipo: file.type
                        });
                    }
                }
                
                // Coleta os dias da semana se for tarefa de rotina
                let diasSemana = [];
                if (isRotina) {
                    const checkboxes = document.querySelectorAll('input[name="diaSemana"]:checked');
                    diasSemana = Array.from(checkboxes).map(cb => parseInt(cb.value));
                }
                
                // Prepara os dados dos usuários atribuídos
                const atribuidos = selectedUsers.map(user => ({
                    id: user.id,
                    nome: user.nome,
                    email: user.email
                }));
                
                // Define o status inicial
                let statusInicial = 'pendente';
                if (atribuidos.length > 0 && !atribuidos.some(a => a.id === usuarioLogado.id)) {
                    statusInicial = 'atribuida_pendente_aceitacao';
                }
                
                // Cria o objeto da demanda
                const novaDemanda = {
                    nomeDemanda,
                    funcionarioId: usuarioLogado.id,
                    nomeFuncionario: usuarioLogado.nome,
                    emailFuncionario: usuarioLogado.email,
                    categoria,
                    prioridade,
                    complexidade,
                    descricao,
                    local,
                    dataLimite,
                    dataCriacao: new Date().toISOString(),
                    status: statusInicial,
                    isRotina,
                    diasSemana,
                    tag: `DEM-${Date.now()}`,
                    comentarios: '',
                    comentarioGestor: '',
                    anexosCriacao,
                    atribuidos: atribuidos,
                    customTags: customTags
                };
                
                // Salva no servidor
                const sucesso = await salvarDemandaNoServidor(novaDemanda);
                
                if (sucesso) {
                    // Adiciona ao histórico de atividades
                    adicionarAtividade({
                        tipo: 'create',
                        usuario: usuarioLogado.nome,
                        demanda: nomeDemanda,
                        descricao: `Nova demanda criada: ${nomeDemanda}`,
                        data: new Date()
                    });
                    
                    // Recarrega dados do servidor
                    await carregarDadosDoServidor();
                    
                    // Envia notificações para as partes interessadas
                    notificarPartesInteressadasNovaDemanda(novaDemanda);
                    
                    // Envia integrações
                    if (integrations.slack) sendToSlack(novaDemanda);
                    if (integrations.teams) sendToTeams(novaDemanda);
                    if (integrations.calendar) sendToCalendar(novaDemanda);
                    
                    // Limpa o formulário
                    form.reset();
                    document.getElementById('anexosCriacaoList').innerHTML = '';
                    
                    // Limpa a seleção de usuários e tags
                    selectedUsers = [];
                    customTags = [];
                    updateSelectedUsers();
                    renderTags();
                    
                    // Mostra notificação de sucesso
                    showNotification('success', 'Demanda Registrada', `Sua demanda "${nomeDemanda}" foi registrada com sucesso!`);
                    
                    // Muda para a aba de pendentes automaticamente
                    setTimeout(() => {
                        switchTab('pendentes');
                    }, 1000);
                }
            });
        }

        // Formulário de resolução
        const resolucaoForm = document.getElementById('resolucaoForm');
        if (resolucaoForm) {
            resolucaoForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                await salvarResolucao();
            });
        }

        // Formulário de reprovação por atribuição
        const atribuicaoReprovacaoForm = document.getElementById('atribuicaoReprovacaoForm');
        if (atribuicaoReprovacaoForm) {
            atribuicaoReprovacaoForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                await salvarReprovacaoAtribuicao();
            });
        }

        // Listener para os inputs de arquivos
        const anexosInput = document.getElementById('resolucaoAnexos');
        if (anexosInput) {
            anexosInput.addEventListener('change', atualizarListaAnexos);
        }
        
        const anexosCriacaoInput = document.getElementById('anexosCriacaoInput');
        if (anexosCriacaoInput) {
            anexosCriacaoInput.addEventListener('change', atualizarListaAnexosCriacao);
        }
        
        // Busca global
        const searchInput = document.getElementById('globalSearch');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                if (term.length > 2) {
                    pesquisarGlobal(term);
                }
            });
        }
        
        // Modo escuro
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }
        
        // Fecha os dropdowns quando clicar fora
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.multi-select-container')) {
                document.querySelectorAll('.multi-select-dropdown').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
            }
        });
        
        // Listener para input de tags
        const tagInput = document.getElementById('tagInput');
        if (tagInput) {
            tagInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTag();
                }
            });
        }
        
        console.log('Event listeners inicializados!');
    }

    // Funções de integração
    function sendToSlack(demanda) {
        // Simula envio para Slack
        console.log('Enviando para Slack:', demanda);
        showNotification('info', 'Slack', `Notificação enviada para Slack: ${demanda.nomeDemanda}`);
    }

    function sendToTeams(demanda) {
        // Simula envio para Teams
        console.log('Enviando para Teams:', demanda);
        showNotification('info', 'Teams', `Notificação enviada para Teams: ${demanda.nomeDemanda}`);
    }

    function sendToCalendar(demanda) {
        // Simula envio para Calendário
        console.log('Enviando para Calendário:', demanda);
        showNotification('info', 'Calendário', `Evento criado no calendário: ${demanda.nomeDemanda}`);
    }

    // Função de pesquisa global
    function pesquisarGlobal(term) {
        const resultados = todasDemandas.filter(d => 
            d.nomeDemanda?.toLowerCase().includes(term) ||
            d.descricao?.toLowerCase().includes(term) ||
            d.categoria?.toLowerCase().includes(term) ||
            d.nomeFuncionario?.toLowerCase().includes(term)
        );
        
        if (resultados.length > 0) {
            showNotification('info', 'Resultados', `Encontrados ${resultados.length} resultados para "${term}"`);
            // Aqui poderia exibir os resultados em uma modal ou seção dedicada
        } else {
            showNotification('warning', 'Pesquisa', `Nenhum resultado encontrado para "${term}"`);
        }
    }

    // Continuação das funções existentes (mantidas para compatibilidade)...
    function atualizarListaAnexosCriacao() {
        const anexosInput = document.getElementById('anexosCriacaoInput');
        const anexosList = document.getElementById('anexosCriacaoList');
        anexosList.innerHTML = '';

        if (anexosInput.files.length === 0) {
            anexosList.innerHTML = '<p>Nenhum arquivo selecionado.</p>';
            return;
        }

        for (const file of anexosInput.files) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <span>${file.name} (${(file.size / 1024).toFixed(2)} KB)</span>
            `;
            anexosList.appendChild(fileItem);
        }
    }

    function notificarPartesInteressadasNovaDemanda(demanda) {
        const criador = usuarios.find(u => u.id === demanda.funcionarioId);
        const gestor = usuarios.find(u => u.role === 'gestor');

        // 1. Envia email para o gestor
        if (gestor && gestor.id !== demanda.funcionarioId) {
            const assunto = encodeURIComponent(`Nova Demanda Registrada: ${demanda.nomeDemanda}`);
            let corpo = `Prezado Gestor,\n\nUma nova demanda foi registrada por ${demanda.nomeFuncionario}:\n\n--- Detalhes da Demanda ---\nNome: ${demanda.nomeDemanda}\nDescrição: ${demanda.descricao}\nCategoria: ${demanda.categoria}\nPrioridade: ${demanda.prioridade}\nComplexidade: ${demanda.complexidade}\nLocal: ${demanda.local}\nData Limite: ${new Date(demanda.dataLimite).toLocaleDateString('pt-BR')}\nTAG da Demanda: ${demanda.tag}\n${demanda.isRotina ? 'Tipo: Tarefa de Rotina\n' : ''}\n`;
            
            if (demanda.atribuidos && demanda.atribuidos.length > 0) {
                corpo += `\n--- Atribuição ---\nEsta demanda foi atribuída a: ${demanda.atribuidos.map(a => a.nome).join(', ')}\n`;
            }
            if (demanda.customTags && demanda.customTags.length > 0) {
                corpo += `\n--- Tags ---\n${demanda.customTags.join(', ')}\n`;
            }
            corpo += `\n\nPor favor, acesse o sistema para analisar e aprovar ou reprovar esta demanda.\n\nAtenciosamente,\nSistema Automático`;
            
            window.open(`mailto:${gestor.email}?subject=${assunto}&body=${encodeURIComponent(corpo)}`, '_blank');
        }

        // 2. Envia email para os funcionários atribuídos
        if (demanda.atribuidos && demanda.atribuidos.length > 0) {
            demanda.atribuidos.forEach(atribuido => {
                if (atribuido.id !== demanda.funcionarioId) {
                    const assuntoAtribuido = encodeURIComponent(`Nova Demanda Atribuída: ${demanda.nomeDemanda}`);
                    let corpoAtribuido = `Prezado(a) ${atribuido.nome},\n\nUma nova demanda foi atribuída a você por ${demanda.nomeFuncionario}:\n\n--- Detalhes da Demanda ---\nNome: ${demanda.nomeDemanda}\nDescrição: ${demanda.descricao}\nCategoria: ${demanda.categoria}\nPrioridade: ${demanda.prioridade}\nComplexidade: ${demanda.complexidade}\nLocal: ${demanda.local}\nData Limite: ${new Date(demanda.dataLimite).toLocaleDateString('pt-BR')}\nTAG da Demanda: ${demanda.tag}\n${demanda.isRotina ? 'Tipo: Tarefa de Rotina\n' : ''}\n`;
                    corpoAtribuido += `\nPor favor, acesse o sistema para ACEITAR ou REPROVAR esta demanda.\n\nAtenciosamente,\nSistema Automático`;
                    
                    window.open(`mailto:${atribuido.email}?subject=${assuntoAtribuido}&body=${encodeURIComponent(corpoAtribuido)}`, '_blank');
                }
            });
        }

        // 3. Envia email de confirmação para o criador
        if (demanda.atribuidos && demanda.atribuidos.length > 0 && !demanda.atribuidos.some(a => a.id === demanda.funcionarioId)) {
            const assuntoCriador = encodeURIComponent(`Sua Demanda Foi Enviada: ${demanda.nomeDemanda}`);
            let corpoCriador = `Prezado(a) ${demanda.nomeFuncionario},\n\nSua demanda "${demanda.nomeDemanda}" foi registrada e atribuída a ${demanda.atribuidos.map(a => a.nome).join(', ')}.\n\nEles(as) receberão um email separado para análise.\n\n--- Detalhes da Demanda ---\nNome: ${demanda.nomeDemanda}\nDescrição: ${demanda.descricao}\nCategoria: ${demanda.categoria}\nPrioridade: ${demanda.prioridade}\nComplexidade: ${demanda.complexidade}\nLocal: ${demanda.local}\nData Limite: ${new Date(demanda.dataLimite).toLocaleDateString('pt-BR')}\nTAG da Demanda: ${demanda.tag}\n${demanda.isRotina ? 'Tipo: Tarefa de Rotina\n' : ''}\n\nAcompanhe o andamento pelo sistema.\n\nAtenciosamente,\nSistema Automático`;
            
            window.open(`mailto:${demanda.emailFuncionario}?subject=${assuntoCriador}&body=${encodeURIComponent(corpoCriador)}`, '_blank');
        }
    }

    function abrirModalResolucao(demandaId) {
        demandaResolucaoAtual = todasDemandas.find(d => d.id === demandaId);
        if (!demandaResolucaoAtual) return;

        document.getElementById('resolucaoComentarios').value = demandaResolucaoAtual.comentarios || '';
        showModal('resolucaoModal', `Resolver Demanda: ${demandaResolucaoAtual.nomeDemanda}`);
        
        // Carrega comentários existentes
        carregarComentariosDemanda(demandaId);
    }

    function carregarComentariosDemanda(demandaId) {
        // Simula carregamento de comentários
        const comentariosExistentes = [
            { author: 'Sistema', text: 'Demanda criada', time: new Date() }
        ];
        
        const container = document.getElementById('commentsContainer');
        container.innerHTML = comentariosExistentes.map(comment => `
            <div class="comment-item">
                <div class="comment-avatar">${comment.author.charAt(0)}</div>
                <div class="comment-content">
                    <div class="comment-header">
                        <span class="comment-author">${comment.author}</span>
                        <span class="comment-time">${formatTime(comment.time)}</span>
                    </div>
                    <div class="comment-text">${comment.text}</div>
                </div>
            </div>
        `).join('');
    }

    function abrirModalReprovarAtribuicao(demandaId) {
        demandaAtribuicaoAtual = todasDemandas.find(d => d.id === demandaId);
        if (!demandaAtribuicaoAtual) return;

        document.getElementById('motivoReprovacaoAtribuicao').value = '';
        showModal('atribuicaoReprovacaoModal', `Reprovar Demanda: ${demandaAtribuicaoAtual.nomeDemanda}`);
    }

    function atualizarListaAnexos() {
        const anexosInput = document.getElementById('resolucaoAnexos');
        const anexosList = document.getElementById('anexosList');
        anexosList.innerHTML = '';

        if (anexosInput.files.length === 0) {
            anexosList.innerHTML = '<p>Nenhum arquivo selecionado.</p>';
            return;
        }

        for (const file of anexosInput.files) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <span>${file.name} (${(file.size / 1024).toFixed(2)} KB)</span>
            `;
            anexosList.appendChild(fileItem);
        }
    }

    async function salvarResolucao() {
        if (!demandaResolucaoAtual) return;

        const comentarios = document.getElementById('resolucaoComentarios').value;
        const anexosInput = document.getElementById('resolucaoAnexos');
        const files = anexosInput.files;

        if (!comentarios && files.length === 0) {
            showNotification('warning', 'Ação Incompleta', 'Por favor, adicione comentários ou anexe pelo menos um arquivo.');
            return;
        }

        try {
            // 1. Criar o arquivo ZIP
            const zip = new JSZip();
            const dataConclusao = new Date();
            const zipFileName = `${demandaResolucaoAtual.tag}_${dataConclusao.toISOString().split('T')[0]}.zip`;

            // Adicionar comentários como um arquivo de texto
            if (comentarios) {
                zip.file("comentarios.txt", comentarios);
            }

            // Adicionar os arquivos anexados
            for (const file of files) {
                zip.file(file.name, file);
            }

            // Gerar o arquivo ZIP
            const zipBlob = await zip.generateAsync({ type: "blob" });

            // 2. Fazer o download do ZIP
            const url = URL.createObjectURL(zipBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = zipFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // 3. Atualizar a demanda no servidor
            const dadosAtualizados = {
                comentarios: comentarios,
                status: 'finalizado_pendente_aprovacao'
            };

            const sucesso = await atualizarDemandaNoServidor(demandaResolucaoAtual.id, dadosAtualizados);

            if (sucesso) {
                showNotification('success', 'Resolução Salva', `A resolução foi salva e o arquivo ${zipFileName} foi baixado. A demanda agora está em análise.`);
                closeModal('resolucaoModal');
                await carregarDadosDoServidor();
                switchTab('pendentes');
            }

        } catch (error) {
            console.error('Erro ao salvar resolução:', error);
            showNotification('error', 'Erro ao Salvar', 'Ocorreu um erro ao processar a resolução.');
        }
    }

    async function salvarReprovacaoAtribuicao() {
        if (!demandaAtribuicaoAtual) return;

        const motivo = document.getElementById('motivoReprovacaoAtribuicao').value;
        if (!motivo) {
            showNotification('warning', 'Motivo Obrigatório', 'Por favor, informe o motivo da reprovação.');
            return;
        }

        const dadosAtualizados = {
            status: 'reprovada_pelo_atribuido',
            comentarioReprovacaoAtribuicao: motivo,
            dataConclusao: new Date().toISOString()
        };

        const sucesso = await atualizarDemandaNoServidor(demandaAtribuicaoAtual.id, dadosAtualizados);

        if (sucesso) {
            showNotification('warning', 'Demanda Reprovada', `A demanda foi reprovada e o solicitante será notificado.`);
            closeModal('atribuicaoReprovacaoModal');
            await carregarDadosDoServidor();

            // Envia email para o criador da demanda
            const criador = usuarios.find(u => u.id === demandaAtribuicaoAtual.funcionarioId);
            if (criador) {
                const assunto = encodeURIComponent(`Sua Demanda Foi Reprovada: ${demandaAtribuicaoAtual.nomeDemanda}`);
                let corpo = `Prezado(a) ${demandaAtribuicaoAtual.nomeFuncionario},\n\nGostaríamos de informar que sua demanda foi analisada e, infelizmente, **reprovada** pela pessoa a quem foi atribuída.\n\n--- Detalhes da Demanda ---\nNome: ${demandaAtribuicaoAtual.nomeDemanda}\nDescrição: ${demandaAtribuicaoAtual.descricao}\nCategoria: ${demandaAtribuicaoAtual.categoria}\nLocal: ${demandaAtribuicaoAtual.local || 'N/A'}\nTAG da Demanda: ${demandaAtribuicaoAtual.tag}\n${demandaAtribuicaoAtual.isRotina ? 'Tipo: Tarefa de Rotina\n' : ''}\n\n--- Motivo da Reprovação ---\n${motivo}\n\nSugerimos que revise os pontos acima com a pessoa que lhe atribuiu a tarefa e, se necessário, crie uma nova demanda com os ajustes necessários.\n\nAtenciosamente,\nSistema de Gestão`;
                window.open(`mailto:${criador.email}?subject=${assunto}&body=${encodeURIComponent(corpo)}`, '_blank');
            }
        }
    }

    async function aceitarDemandaAtribuida(demandaId) {
        if (!confirm('Tem certeza que deseja aceitar esta demanda? Ela passará para o seu status de "Em Andamento".')) return;
        
        const demanda = todasDemandas.find(d => d.id === demandaId);
        if (demanda) {
            const dadosAtualizados = {
                status: 'pendente'
            };
            
            const sucesso = await atualizarDemandaNoServidor(demandaId, dadosAtualizados);
            
            if (sucesso) {
                await carregarDadosDoServidor();
                showNotification('success', 'Demanda Aceita', `Você aceitou a demanda "${demanda.nomeDemanda}". Ela agora está em seu painel para ser resolvida.`);
                
                // Notifica o criador da demanda
                const criador = usuarios.find(u => u.id === demanda.funcionarioId);
                if (criador) {
                    const assunto = encodeURIComponent(`Sua Demanda Foi Aceita: ${demanda.nomeDemanda}`);
                    const corpo = encodeURIComponent(`Prezado(a) ${criador.nome},\n\nTemos uma boa notícia! A demanda "${demanda.nomeDemanda}" que você atribuiu foi **ACEITA**.\n\nEla agora está sendo trabalhada.\n\nAcompanhe o progresso pelo sistema.\n\nAtenciosamente,\nSistema de Gestão`);
                    window.open(`mailto:${criador.email}?subject=${assunto}&body=${corpo}`, '_blank');
                }
            }
        }
    }

    function calcularDesempenhoTempo(dataCriacao, dataConclusao, dataLimite) {
        const conclusao = new Date(dataConclusao);
        const limite = new Date(dataLimite);
        
        const diffMs = conclusao - limite;
        const diffHoras = Math.abs(diffMs) / (1000 * 60 * 60);
        const diffDias = Math.floor(diffHoras / 24);
        const diffHorasRestantes = Math.floor(diffHoras % 24);

        let tempoTexto = '';
        if (diffDias > 0) {
            tempoTexto = `${diffDias} dia(s) e ${diffHorasRestantes} hora(s)`;
        } else {
            tempoTexto = `${diffHorasRestantes} hora(s)`;
        }

        if (diffMs > 0) {
            return `Concluído ${tempoTexto} após o prazo`;
        } else {
            return `Concluído ${tempoTexto} antes do prazo`;
        }
    }

    function solicitarSenhaParaAprovar(id, nomeFuncionario) {
        pendingAction = {
            type: 'aprovar',
            id: id,
            nomeFuncionario: nomeFuncionario
        };
        document.getElementById('passwordModal').style.display = 'block';
        document.getElementById('passwordConfirm').value = '';
        document.getElementById('passwordConfirm').focus();
    }

    function solicitarSenhaParaReprovar(id, nomeFuncionario) {
        pendingAction = {
            type: 'reprovar',
            id: id,
            nomeFuncionario: nomeFuncionario
        };
        document.getElementById('passwordModal').style.display = 'block';
        document.getElementById('passwordConfirm').value = '';
        document.getElementById('passwordConfirm').focus();
    }

    function confirmPassword() {
        const password = document.getElementById('passwordConfirm').value;
        const gestor = usuarios.find(u => u.role === 'gestor');
        
        if (!gestor || password !== gestor.senha) {
            showNotification('error', 'Senha Incorreta', 'A senha do gestor está incorreta.');
            return;
        }
        
        if (pendingAction.type === 'aprovar') {
            aprovarDemanda(pendingAction.id, pendingAction.nomeFuncionario);
        } else if (pendingAction.type === 'reprovar') {
            reprovarDemanda(pendingAction.id, pendingAction.nomeFuncionario);
        }
        
        closePasswordModal();
    }

    function closePasswordModal() {
        document.getElementById('passwordModal').style.display = 'none';
        pendingAction = null;
    }

    function verDetalhes(id) {
        const demanda = todasDemandas.find(d => d.id === id);
        if (!demanda) return;
        
        let tempoInfo = '';
        if (demanda.status === 'aprovada' && demanda.dataConclusao) {
            tempoInfo = `<p><strong>Desempenho de Tempo:</strong> ${calcularDesempenhoTempo(demanda.dataCriacao, demanda.dataConclusao, demanda.dataLimite)}</p>`;
        }
        
        let atribuidosInfo = '';
        if (demanda.atribuidos && demanda.atribuidos.length > 0) {
            atribuidosInfo = `<p><strong>Atribuída a:</strong> ${demanda.atribuidos.map(a => a.nome).join(', ')}</p>`;
        }
        
        let tagsInfo = '';
        if (demanda.customTags && demanda.customTags.length > 0) {
            tagsInfo = `<p><strong>Tags:</strong> ${demanda.customTags.join(', ')}</p>`;
        }
        
        const content = `
            <div class="demanda-details">
                <h3>${demanda.nomeDemanda || demanda.descricao}</h3>
                <p><strong>Funcionário:</strong> ${demanda.nomeFuncionario}</p>
                <p><strong>Categoria:</strong> ${demanda.categoria}</p>
                <p><strong>Status:</strong> ${demanda.status}</p>
                <p><strong>Data Limite:</strong> ${new Date(demanda.dataLimite).toLocaleDateString('pt-BR')}</p>
                <p><strong>Data Criação:</strong> ${new Date(demanda.dataCriacao).toLocaleDateString('pt-BR')}</p>
                ${demanda.dataConclusao ? `<p><strong>Data Conclusão:</strong> ${new Date(demanda.dataConclusao).toLocaleDateString('pt-BR')}</p>` : ''}
                ${tempoInfo}
                ${demanda.comentarios ? `<p><strong>Comentários do Funcionário:</strong> ${demanda.comentarios}</p>` : ''}
                ${demanda.comentarioGestor ? `<p><strong>Comentário do Gestor:</strong> ${demanda.comentarioGestor}</p>` : ''}
                ${demanda.comentarioReprovacaoAtribuicao ? `<p><strong>Motivo da Reprovação:</strong> ${demanda.comentarioReprovacaoAtribuicao}</p>` : ''}
                ${demanda.isRotina ? `<p><strong>Tipo:</strong> Tarefa de Rotina</p>` : ''}
                ${atribuidosInfo}
                ${tagsInfo}
            </div>
        `;
        
        showModal('detailModal', 'Detalhes da Demanda', content);
    }

    function calcularTempoRestante(dataLimite) {
        const agora = new Date();
        const limite = new Date(dataLimite);
        const diferenca = limite - agora;
        
        if (diferenca < 0) {
            const diasAtraso = Math.floor(Math.abs(diferenca) / (1000 * 60 * 60 * 24));
            const horasAtraso = Math.floor((Math.abs(diferenca) % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutosAtraso = Math.floor((Math.abs(diferenca) % (1000 * 60 * 60)) / (1000 * 60));
            const segundosAtraso = Math.floor((Math.abs(diferenca) % (1000 * 60)) / 1000);
            
            return `${diasAtraso}d ${horasAtraso}h ${minutosAtraso}m ${segundosAtraso}s`;
        } else {
            const diasRestantes = Math.floor(diferenca / (1000 * 60 * 60 * 24));
            const horasRestantes = Math.floor((diferenca % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutosRestantes = Math.floor((diferenca % (1000 * 60 * 60)) / (1000 * 60));
            const segundosRestantes = Math.floor((diferenca % (1000 * 60)) / 1000);
            
            return `${diasRestantes}d ${horasRestantes}h ${minutosRestantes}m ${segundosRestantes}s`;
        }
    }

    function atualizarTemposRestantes() {
        document.querySelectorAll('.time-remaining').forEach(element => {
            const divPai = element.closest('.demanda-item');
            if (divPai) {
                const botoes = divPai.querySelectorAll('button');
                let demandaId = null;
                
                botoes.forEach(botao => {
                    const onclick = botao.getAttribute('onclick');
                    if (onclick && onclick.includes('abrirModalResolucao')) {
                        const match = onclick.match(/abrirModalResolucao\((\d+)/);
                        if (match) demandaId = parseInt(match[1]);
                    } else if (onclick && onclick.includes('solicitarSenhaParaAprovar')) {
                        const match = onclick.match(/solicitarSenhaParaAprovar\((\d+)/);
                        if (match) demandaId = parseInt(match[1]);
                    } else if (onclick && onclick.includes('solicitarSenhaParaReprovar')) {
                        const match = onclick.match(/solicitarSenhaParaReprovar\((\d+)/);
                        if (match) demandaId = parseInt(match[1]);
                    } else if (onclick && onclick.includes('apagarDemanda')) {
                        const match = onclick.match(/apagarDemanda\((\d+)/);
                        if (match) demandaId = parseInt(match[1]);
                    }
                });
                
                if (demandaId) {
                    const demanda = todasDemandas.find(d => d.id === demandaId);
                    
                    if (demanda) {
                        const isAtrasado = divPai.classList.contains('atrasado');
                        const tempoRestante = calcularTempoRestante(demanda.dataLimite);
                        element.textContent = `${isAtrasado ? 'ATRASADA HÁ ' : 'TEMPO RESTANTE: '}${tempoRestante}`;
                    }
                }
            }
        });
    }

    async function aprovarDemanda(id, nomeFuncionario) {
        if (!confirm('Tem certeza que deseja aprovar esta demanda?')) return;
        const demanda = todasDemandas.find(d => d.id === id);
        if (demanda) {
            const dadosAtualizados = {
                status: 'aprovada',
                dataConclusao: new Date().toISOString()
            };
            
            const sucesso = await atualizarDemandaNoServidor(id, dadosAtualizados);
            
            if (sucesso) {
                // Adiciona ao histórico
                adicionarAtividade({
                    tipo: 'approve',
                    usuario: usuarioLogado.nome,
                    demanda: demanda.nomeDemanda,
                    descricao: `Demanda aprovada: ${demanda.nomeDemanda}`,
                    data: new Date()
                });
                
                await carregarDadosDoServidor();
                showNotification('success', 'Demanda Aprovada', `Demanda de ${nomeFuncionario} foi aprovada com sucesso!`);
                
                // Envia email para o funcionário
                const funcionario = usuarios.find(u => u.id === demanda.funcionarioId);
                if (funcionario) {
                    const assunto = encodeURIComponent(`Sua Demanda Foi Aprovada: ${demanda.nomeDemanda || demanda.descricao}`);
                    let corpo = `Prezado(a) ${nomeFuncionario},\n\nGostaríamos de informar que sua demanda foi analisada e **aprovada**.\n\n--- Detalhes da Demanda ---\nNome: ${demanda.nomeDemanda || demanda.descricao}\nCategoria: ${demanda.categoria}\nLocal: ${demanda.local || 'N/A'}\nTAG da Demanda: ${demanda.tag}\n${demanda.isRotina ? 'Tipo: Tarefa de Rotina\n' : ''}\n\nParabéns pelo excelente trabalho!\n\nAtenciosamente,\nGestão`;
                    
                    if (demanda.comentarios) {
                        corpo += encodeURIComponent('\n\n--- Importante ---\nPor favor, não se esqueça de anexar o arquivo ZIP com a resolução que você baixou no email de resposta, se aplicável.');
                    }

                    window.open(`mailto:${funcionario.email}?subject=${assunto}&body=${corpo}`, '_blank');
                }
            }
        }
    }

    async function reprovarDemanda(id, nomeFuncionario) {
        const motivo = prompt('Por favor, justifique o motivo da reprovação:');
        if (!motivo) return;

        const demanda = todasDemandas.find(d => d.id === id);
        if (demanda) {
            const dadosAtualizados = {
                status: 'reprovada',
                dataConclusao: new Date().toISOString(),
                comentarioGestor: motivo
            };
            
            const sucesso = await atualizarDemandaNoServidor(id, dadosAtualizados);
            
            if (sucesso) {
                // Adiciona ao histórico
                adicionarAtividade({
                    tipo: 'reject',
                    usuario: usuarioLogado.nome,
                    demanda: demanda.nomeDemanda,
                    descricao: `Demanda reprovada: ${demanda.nomeDemanda}`,
                    data: new Date()
                });
                
                await carregarDadosDoServidor();
                showNotification('warning', 'Demanda Reprovada', `Demanda de ${nomeFuncionario} foi reprovada.`);
                
                // Envia email para o funcionário
                const funcionario = usuarios.find(u => u.id === demanda.funcionarioId);
                if (funcionario) {
                    const assunto = encodeURIComponent(`Sua Demanda Foi Reprovada: ${demanda.nomeDemanda || demanda.descricao}`);
                    const corpo = encodeURIComponent(`Prezado(a) ${nomeFuncionario},\n\nGostaríamos de informar que sua demanda foi analisada e, infelizmente, **reprovada** neste momento.\n\n--- Detalhes da Demanda ---\nNome: ${demanda.nomeDemanda || demanda.descricao}\nCategoria: ${demanda.categoria}\nLocal: ${demanda.local || 'N/A'}\nTAG da Demanda: ${demanda.tag}\n${demanda.isRotina ? 'Tipo: Tarefa de Rotina\n' : ''}\n\n--- Motivo da Reprovação ---\n${motivo}\n\nSugerimos que revise os pontos acima e, se necessário, entre em contato para maiores esclarecimentos.\n\nAtenciosamente,\nGestão`);
                    window.open(`mailto:${funcionario.email}?subject=${assunto}&body=${corpo}`, '_blank');
                }
            }
        }
    }
    
    async function apagarDemanda(id) {
        if (!confirm('Tem certeza que deseja apagar esta demanda? Esta ação não pode ser desfeita.')) return;
        
        const sucesso = await deletarDemandaDoServidor(id);
        
        if (sucesso) {
            await carregarDadosDoServidor();
            showNotification('info', 'Demanda Apagada', 'Demanda removida com sucesso.');
        }
    }

    function atualizarRanking() {
        // Conta as demandas por status para cada funcionário
        const ranking = {};
        
        usuarios.filter(u => u.role === 'funcionario').forEach(func => {
            ranking[func.id] = {
                nome: func.nome,
                concluidas: 0,
                andamento: 0,
                atrasadas: 0
            };
        });
        
        todasDemandas.forEach(demanda => {
            if (ranking[demanda.funcionarioId]) {
                if (demanda.status === 'aprovada') {
                    ranking[demanda.funcionarioId].concluidas++;
                } else if (demanda.status === 'pendente' || demanda.status === 'finalizado_pendente_aprovacao' || demanda.status === 'reprovada' || demanda.status === 'atribuida_pendente_aceitacao' || demanda.status === 'reprovada_pelo_atribuido') {
                    ranking[demanda.funcionarioId].andamento++;
                }
                
                const dataLimite = new Date(demanda.dataLimite);
                const hoje = new Date();
                if (dataLimite < hoje && demanda.status !== 'aprovada') {
                    ranking[demanda.funcionarioId].atrasadas++;
                }
            }
        });
        
        // Converte o objeto em array e ordena por número de demandas concluídas
        const rankingArray = Object.values(ranking).sort((a, b) => b.concluidas - a.concluidas);
        
        // Renderiza o ranking
        const rankingList = document.getElementById('rankingList');
        if (rankingList) {
            rankingList.innerHTML = '';
            
            rankingArray.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'ranking-item';
                
                li.innerHTML = `
                    <div class="ranking-position">${index + 1}</div>
                    <div class="ranking-info">
                        <strong>${item.nome}</strong>
                        <div class="ranking-stats">
                            <div class="ranking-stat">
                                <span class="stat-badge concluidas">${item.concluidas} concluídas</span>
                            </div>
                            <div class="ranking-stat">
                                <span class="stat-badge andamento">${item.andamento} em andamento</span>
                            </div>
                            <div class="ranking-stat">
                                <span class="stat-badge atrasadas">${item.atrasadas} atrasadas</span>
                            </div>
                        </div>
                    </div>
                `;
                
                rankingList.appendChild(li);
            });
        }
    }

    function validateDeadline() {
        const deadlineInput = document.getElementById('dataLimiteInput');
        if (!deadlineInput) return;
        
        const deadline = new Date(deadlineInput.value);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (deadline < today) {
            showNotification('warning', 'Data Inválida', 'A data limite não pode ser anterior a hoje');
            deadlineInput.value = '';
        }
    }

    function toggleRoutineFields() {
        const rotinaCheckbox = document.getElementById('rotinaCheckbox');
        const diasSemanaGroup = document.getElementById('diasSemanaGroup');
        
        if (diasSemanaGroup) {
            diasSemanaGroup.style.display = rotinaCheckbox.checked ? 'block' : 'none';
        }
    }

    function showNotification(type, title, message) {
        const notification = document.getElementById('notification');
        const titleElement = document.getElementById('notificationTitle');
        const messageElement = document.getElementById('notificationMessage');
        
        if (!notification || !titleElement || !messageElement) {
            console.error('Elementos de notificação não encontrados!');
            return;
        }
        
        notification.className = `notification ${type} show`;
        titleElement.textContent = title;
        messageElement.textContent = message;
        
        // Adiciona ao array de notificações
        notifications.push({
            tipo: type,
            titulo: title,
            mensagem: message,
            data: new Date()
        });
        
        // Remove notificação após 5 segundos
        setTimeout(() => {
            notification.classList.remove('show');
        }, 5000);
    }

    function resetFilters() {
        document.getElementById('filtroFuncionario').value = 'todos';
        document.getElementById('filtroPeriodo').value = '7';
        document.getElementById('filtroCategoria').value = 'todas';
        document.getElementById('filtroPrioridade').value = 'todas';
        
        filtrarDashboard();
        showNotification('info', 'Filtros Resetados', 'Todos os filtros foram resetados');
    }

    function drillDown(type) {
        showNotification('info', 'Análise Detalhada', `Analisando detalhes de ${type}...`);
        
        setTimeout(() => {
            switchTab('pendentes');
        }, 1000);
    }

    function bulkApprove() {
        showNotification('info', 'Aprovação em Lote', 'Funcionalidade em desenvolvimento');
    }

    function bulkReject() {
        showNotification('info', 'Reprovação em Lote', 'Funcionalidade em desenvolvimento');
    }

    function reassignOverdue() {
        showNotification('info', 'Reatribuir Atrasadas', 'Funcionalidade em desenvolvimento');
    }

    function extendDeadlines() {
        showNotification('info', 'Estender Prazos', 'Funcionalidade em desenvolvimento');
    }

    function exportCompleted() {
        showNotification('info', 'Exportar Concluídas', 'Exportando demandas concluídas...');
    }

    function archiveCompleted() {
        showNotification('info', 'Arquivar Concluídas', 'Arquivando demandas concluídas...');
    }

    function changeRankingPeriod() {
        showNotification('info', 'Alterar Período', 'Selecionando período do ranking...');
    }

    function exportRanking() {
        showNotification('info', 'Exportar Ranking', 'Exportando dados do ranking...');
    }

    function exportData() {
        showNotification('info', 'Exportação Iniciada', 'Exportando dados...');
    }

    function scheduleExport() {
        showNotification('info', 'Agendar Exportação', 'Funcionalidade em desenvolvimento');
    }

    function inicializarImportacaoJSON() {
        // Mantido para compatibilidade futura
    }

    function atualizarDashboard() {
        const demandasFiltradas = getDemandasFiltradas();
        const totalDemandas = demandasFiltradas.length;
        const pendentes = demandasFiltradas.filter(d => d.status === 'pendente' || d.status === 'finalizado_pendente_aprovacao' || d.status === 'reprovada' || d.status === 'atribuida_pendente_aceitacao').length;
        const atrasadas = demandasFiltradas.filter(d => {
            if (d.status === 'aprovada') return false;
            const dataLimite = new Date(d.dataLimite);
            const hoje = new Date();
            return dataLimite < hoje;
        }).length;
        const aprovadas = demandasFiltradas.filter(d => d.status === 'aprovada').length;
        const rotina = demandasFiltradas.filter(d => d.isRotina).length;

        animateValue('totalDemandas', totalDemandas);
        animateValue('pendentesCount', pendentes);
        animateValue('atrasadasCount', atrasadas);
        animateValue('aprovadasCount', aprovadas);
        animateValue('rotinaCount', rotina);
    }

    function getDemandasFiltradas() {
        if (filtroFuncionarioAtual === 'todos') {
            return todasDemandas;
        }
        return todasDemandas.filter(d => d.funcionarioId == filtroFuncionarioAtual);
    }

    function animateValue(elementId, value) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        const current = parseInt(element.textContent) || 0;
        const increment = value > current ? 1 : -1;
        const duration = 500;
        const steps = Math.abs(value - current);
        
        if (steps === 0) return;
        
        const stepDuration = duration / steps;
        let step = 0;
        
        const timer = setInterval(() => {
            step++;
            element.textContent = current + (increment * step);
            
            if (step >= steps) {
                clearInterval(timer);
                element.textContent = value;
            }
        }, stepDuration);
    }

    function inicializarGraficos() {
        if (typeof Chart === 'undefined') {
            console.log('Chart.js não carregado, pulando inicialização dos gráficos');
            return;
        }
        
        Chart.register(ChartDataLabels);

        // Gráfico de pizza - Status
        const statusCtx = document.getElementById('statusChart');
        if (statusCtx) {
            charts.status = new Chart(statusCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Em Andamento', 'Aprovadas', 'Reprovadas', 'Em Análise'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(255,193, 7, 0.8)',
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(0, 86, 179, 0.8)'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        datalabels: {
                            color: '#fff',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: (value, ctx) => {
                                const sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = sum > 0 ? ((value / sum) * 100).toFixed(1) + '%' : '0%';
                                return percentage;
                            }
                        }
                    }
                }
            });
        }

        // Gráfico de barras - Categorias
        const categoriaCtx = document.getElementById('categoriaChart');
        if (categoriaCtx) {
            charts.categoria = new Chart(categoriaCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Prospecção', 'Reunião', 'Relatório', 'Suporte', 'Desenvolvimento', 'Outros'],
                    datasets: [{
                        label: 'Demandas',
                        data: [0, 0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(0, 86, 179, 0.8)',
                        borderColor: 'rgba(0, 86, 179, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#333',
                            font: {
                                weight: 'bold'
                            }
                        }
                    }
                }
            });
        }

        // Gráfico de produtividade
        const productivityCtx = document.getElementById('productivityChart');
        if (productivityCtx) {
            charts.productivity = new Chart(productivityCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: usuarios.filter(u => u.role === 'funcionario').map(f => f.nome.split(' ')[0]),
                    datasets: [{
                        label: 'Demandas Concluídas',
                        data: usuarios.filter(u => u.role === 'funcionario').map(f => Math.floor(Math.random() * 20) + 5),
                        backgroundColor: 'rgba(40, 167, 69, 0.8)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#333',
                            font: {
                                weight: 'bold'
                            }
                        }
                    }
                }
            });
        }

        atualizarGraficos();
    }

    function atualizarGraficos() {
        if (!charts.status) return;

        const demandasFiltradas = getDemandasFiltradas();

        // Atualizar gráfico de status
        const statusData = [
            demandasFiltradas.filter(d => d.status === 'pendente' || d.status === 'atribuida_pendente_aceitacao').length,
            demandasFiltradas.filter(d => d.status === 'aprovada').length,
            demandasFiltradas.filter(d => d.status === 'reprovada' || d.status === 'reprovada_pelo_atribuido').length,
            demandasFiltradas.filter(d => d.status === 'finalizado_pendente_aprovacao').length
        ];
        charts.status.data.datasets[0].data = statusData;
        charts.status.update();

        // Atualizar gráfico de categorias
        const categorias = ['Prospecção', 'Reunião', 'Relatório', 'Suporte', 'Desenvolvimento', 'Outros'];
        const categoriaData = categorias.map(cat => 
            demandasFiltradas.filter(d => d.categoria === cat).length
        );
        charts.categoria.data.datasets[0].data = categoriaData;
        charts.categoria.update();

        // Atualizar gráfico de produtividade
        charts.productivity.data.datasets[0].data = usuarios.filter(u => u.role === 'funcionario').map(f => 
            demandasFiltradas.filter(d => d.funcionarioId === f.id && d.status === 'aprovada').length
        );
        charts.productivity.update();
    }

    function filtrarDashboard() {
        filtroFuncionarioAtual = document.getElementById('filtroFuncionario').value;
        atualizarDashboard();
        atualizarGraficos();
    }

    function refreshChart(chartType) {
        showNotification('info', 'Atualizando Gráfico', `Atualizando gráfico ${chartType}...`);
        atualizarGraficos();
    }

    function downloadChart(chartType) {
        const chart = charts[chartType];
        if (chart) {
            const url = chart.toBase64Image();
            const link = document.createElement('a');
            link.download = `chart_${chartType}_${Date.now()}.png`;
            link.href = url;
            link.click();
            
            showNotification('success', 'Gráfico Baixado', `Gráfico ${chartType} baixado com sucesso!`);
        }
    }

    function renderizarCobranca() {
        const cobrancaContainer = document.getElementById('cobrancaContainer');
        if (!cobrancaContainer) return;
        
        const funcionarioFilter = document.getElementById('cobrancaFuncionario').value;
        const prioridadeFilter = document.getElementById('cobrancaPrioridade').value;
        
        let atrasadas = todasDemandas.filter(d => {
            if (d.status === 'aprovada') return false;
            const dataLimite = new Date(d.dataLimite);
            const hoje = new Date();
            return dataLimite < hoje;
        });
        
        if (funcionarioFilter !== 'todos') {
            atrasadas = atrasadas.filter(d => d.funcionarioId == funcionarioFilter);
        }
        
        if (prioridadeFilter !== 'todas') {
            atrasadas = atrasadas.filter(d => d.prioridade === prioridadeFilter);
        }
        
        cobrancaContainer.innerHTML = '';
        
        if (atrasadas.length === 0) {
            cobrancaContainer.innerHTML = '<p>Nenhuma demanda atrasada encontrada com os filtros selecionados.</p>';
            return;
        }
        
        const demandasPorFuncionario = {};
        atrasadas.forEach(demanda => {
            if (!demandasPorFuncionario[demanda.funcionarioId]) {
                demandasPorFuncionario[demanda.funcionarioId] = {
                    nome: demanda.nomeFuncionario,
                    email: demanda.emailFuncionario,
                    demandas: []
                };
            }
            demandasPorFuncionario[demanda.funcionarioId].demandas.push(demanda);
        });
        
        Object.values(demandasPorFuncionario).forEach(funcionario => {
            const card = document.createElement('div');
            card.className = 'card';
            
            const checkboxId = `func_${funcionario.nome.replace(/\s+/g, '_')}`;
            
            card.innerHTML = `
                <div class="card-header">
                    <h3><i class="fas fa-user"></i> ${funcionario.nome}</h3>
                    <div class="card-actions">
                        <input type="checkbox" id="${checkboxId}" class="func-checkbox" onchange="toggleFuncionarioSelection(${funcionario.nome.replace(/'/g, "\\'")})">
                        <label for="${checkboxId}">Selecionar</label>
                    </div>
                </div>
                <div class="demandas-list">
                    ${funcionario.demandas.map(demanda => {
                        const dataLimite = new Date(demanda.dataLimite);
                        const hoje = new Date();
                        const diasAtraso = Math.floor((hoje - dataLimite) / (1000 * 60 * 60 * 24));
                        const tempoAtraso = calcularTempoRestante(demanda.dataLimite);
                        
                        return `
                            <div class="demanda-item atrasado">
                                <div class="demanda-info">
                                    <strong>${demanda.nomeDemanda || demanda.descricao}</strong>
                                    <small>Categoria: ${demanda.categoria} | Prioridade: ${demanda.prioridade} | Data Limite: ${dataLimite.toLocaleDateString('pt-BR')}</small>
                                    <small><strong>TAG:</strong> ${demanda.tag}</small>
                                    <div class="time-remaining">ATRASADA HÁ ${tempoAtraso}</div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="card-actions">
                    <button class="success" onclick="enviarEmailCobranca('${funcionario.nome}', '${funcionario.email}')">
                        <i class="fas fa-envelope"></i> Enviar Email de Cobrança
                    </button>
                </div>
            `;
            
            cobrancaContainer.appendChild(card);
        });
        
        atualizarPreviaEmail();
    }

    function filtrarCobranca() {
        renderizarCobranca();
    }

    function resetFiltrosCobranca() {
        document.getElementById('cobrancaFuncionario').value = 'todos';
        document.getElementById('cobrancaPrioridade').value = 'todas';
        renderizarCobranca();
    }

    function selectAllOverdue() {
        document.querySelectorAll('.func-checkbox').forEach(checkbox => {
            checkbox.checked = true;
        });
    }

    function deselectAllOverdue() {
        document.querySelectorAll('.func-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
    }

    function toggleFuncionarioSelection(nomeFuncionario) {
        console.log(`Seleção alterada para: ${nomeFuncionario}`);
    }

    function enviarEmailCobranca(nomeFuncionario, emailFuncionario) {
        const demandasAtrasadas = todasDemandas.filter(d => {
            if (d.status === 'aprovada') return false;
            if (d.nomeFuncionario !== nomeFuncionario) return false;
            const dataLimite = new Date(d.dataLimite);
            const hoje = new Date();
            return dataLimite < hoje;
        });
        
        if (demandasAtrasadas.length === 0) {
            showNotification('warning', 'Nenhuma Demanda Atrasada', `${nomeFuncionario} não possui demandas atrasadas.`);
            return;
        }
        
        let corpoEmail = `Prezado(a) ${nomeFuncionario},\n\n`;
        corpoEmail += `Identificamos que você possui ${demandasAtrasadas.length} demanda(s) em atraso. Por favor, verifique e regularize a situação o mais breve possível.\n\n`;
        corpoEmail += `--- Demandas em Atraso ---\n\n`;
        
        demandasAtrasadas.forEach(demanda => {
            const dataLimite = new Date(demanda.dataLimite);
            const hoje = new Date();
            const diasAtraso = Math.floor((hoje - dataLimite) / (1000 * 60 * 60 * 24));
            const tempoAtraso = calcularTempoRestante(demanda.dataLimite);
            
            corpoEmail += `• ${demanda.nomeDemanda || demanda.descricao}\n`;
            corpoEmail += `  Categoria: ${demanda.categoria}\n`;
            corpoEmail += `  Prioridade: ${demanda.prioridade}\n`;
            corpoEmail += `  Data Limite: ${dataLimite.toLocaleDateString('pt-BR')}\n`;
            corpoEmail += `  Dias de Atraso: ${diasAtraso}\n`;
            corpoEmail += `  TAG: ${demanda.tag}\n\n`;
        });
        
        corpoEmail += `Por favor, acesse o sistema para atualizar o status das demandas ou entrar em contato caso necessite de suporte.\n\n`;
        corpoEmail += `Atenciosamente,\nGestão`;
        
        const assunto = encodeURIComponent(`Cobrança de Demandas em Atraso - ${demandasAtrasadas.length} pendente(s)`);
        const corpo = encodeURIComponent(corpoEmail);
        
        window.open(`mailto:${emailFuncionario}?subject=${assunto}&body=${corpo}`, '_blank');
        
        showNotification('success', 'Email de Cobrança', `Email de cobrança para ${nomeFuncionario} foi aberto para envio.`);
    }

    function sendBulkEmail() {
        const checkboxes = document.querySelectorAll('.func-checkbox:checked');
        
        if (checkboxes.length === 0) {
            showNotification('warning', 'Nenhum Funcionário Selecionado', 'Por favor, selecione pelo menos um funcionário para enviar emails em lote.');
            return;
        }
        
        if (!confirm(`Tem certeza que deseja enviar emails de cobrança para ${checkboxes.length} funcionário(s)?`)) {
            return;
        }
        
        const emails = [];
        checkboxes.forEach(checkbox => {
            const card = checkbox.closest('.card');
            const nome = card.querySelector('h3').textContent.trim();
            const funcionario = usuarios.find(u => u.nome === nome);
            if (funcionario) {
                emails.push({
                    nome: funcionario.nome,
                    email: funcionario.email
                });
            }
        });
        
        emails.forEach((item, index) => {
            setTimeout(() => {
                enviarEmailCobranca(item.nome, item.email);
            }, index * 1000);
        });
    }

    function atualizarPreviaEmail() {
        const emailPreview = document.getElementById('emailPreview');
        if (!emailPreview) return;
        
        const funcionarioFilter = document.getElementById('cobrancaFuncionario').value;
        const prioridadeFilter = document.getElementById('cobrancaPrioridade').value;
        
        let atrasadas = todasDemandas.filter(d => {
            if (d.status === 'aprovada') return false;
            const dataLimite = new Date(d.dataLimite);
            const hoje = new Date();
            return dataLimite < hoje;
        });
        
        if (funcionarioFilter !== 'todos') {
            atrasadas = atrasadas.filter(d => d.funcionarioId == funcionarioFilter);
        }
        
        if (prioridadeFilter !== 'todas') {
            atrasadas = atrasadas.filter(d => d.prioridade === prioridadeFilter);
        }
        
        if (atrasadas.length === 0) {
            emailPreview.textContent = 'Nenhuma demanda em atraso encontrada com os filtros atuais.';
            return;
        }
        
        let corpoEmail = `Prezado(a) [Nome do Funcionário],\n\n`;
        corpoEmail += `Identificamos que você possui ${atrasadas.length} demanda(s) em atraso. Por favor, verifique e regularize a situação o mais breve possível.\n\n`;
        corpoEmail += `--- Demandas em Atraso ---\n\n`;
        
        atrasadas.slice(0, 3).forEach(demanda => {
            const dataLimite = new Date(demanda.dataLimite);
            const hoje = new Date();
            const diasAtraso = Math.floor((hoje - dataLimite) / (1000 * 60 * 60 * 24));
            const tempoAtraso = calcularTempoRestante(demanda.dataLimite);
            
            corpoEmail += `• ${demanda.nomeDemanda || demanda.descricao}\n`;
            corpoEmail += `  Categoria: ${demanda.categoria}\n`;
            corpoEmail += `  Prioridade: ${demanda.prioridade}\n`;
            corpoEmail += `  Data Limite: ${dataLimite.toLocaleDateString('pt-BR')}\n`;
            corpoEmail += `  Dias de Atraso: ${diasAtraso}\n`;
            corpoEmail += `  TAG: ${demanda.tag}\n\n`;
        });
        
        if (atrasadas.length > 3) {
            corpoEmail += `... e mais ${atrasadas.length - 3} demanda(s).\n\n`;
        }
        
        corpoEmail += `Por favor, acesse o sistema para atualizar o status das demandas ou entrar em contato caso necessite de suporte.\n\n`;
        corpoEmail += `Atenciosamente,\nGestão`;
        
        emailPreview.textContent = corpoEmail;
    }

    // Tecla Enter no modal de senha
    document.getElementById('passwordConfirm').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            confirmPassword();
        }
    });

    // Tecla Esc para fechar modais
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closePasswordModal();
            closeModal('resolucaoModal');
            closeModal('atribuicaoReprovacaoModal');
            closeModal('detailModal');
        }
    });
</script>

</body>
</html>
